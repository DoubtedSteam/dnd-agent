# 如何创建新主题（剧本）

本指南将帮助你手动创建一个新的游戏主题（剧本）。

## 目录结构

一个完整的主题应该包含以下目录结构：

```
themes/
└── {theme_name}/                    # 主题名称（如 village_quest）
    ├── STORY_OVERVIEW.md            # 故事总览（必需）
    ├── scene_network.json           # 场景连接网络（必需）
    ├── core_events.json             # 核心事件列表（必需）
    ├── random_events.json           # 随机事件列表（必需）
    ├── monster_bindings.json        # 怪物绑定关系（可选）
    ├── characters/                  # 重要角色卡目录
    │   └── {character_id}.json      # 角色卡文件
    ├── monsters/                    # 怪物卡目录（可选）
    │   └── {monster_id}.json        # 怪物卡文件
    └── scenarios/                   # 场景剧本目录
        ├── scene_{id}_{名称}.json   # 一级场景剧本
        └── scene_{id}/              # 场景子目录（如果包含房间）
            └── rooms/
                └── room_{id}_{名称}.json  # 二级场景（房间）剧本
```

## 必需文件说明

### 1. STORY_OVERVIEW.md

故事总览文件，包含以下内容：

```markdown
# 故事总览

## 背景介绍
{故事背景描述}

## 剧情主线
{主要剧情线描述}

## 场景列表
- scene_001: {场景名称}（起始场景）
- scene_002: {场景名称}
- ...

## 重要角色列表
**重要角色**（需要角色卡）：
- **玩家角色：{角色名称}**（必须创建角色卡）
- 主要NPC：{NPC名称}

**环境NPC**（不需要角色卡）：
- {环境NPC描述}
```

**重要提示**：
- 必须定义起始场景（在场景列表中标记）
- 必须定义重要角色列表（包括玩家角色）
- 玩家角色必须创建角色卡

### 2. scene_network.json

场景连接网络，定义场景之间的连接关系：

```json
{
  "scene_network": {
    "scene_001": [
      {
        "target": "scene_002",
        "type": "scene",
        "condition": "通过事件触发",
        "description": "场景连接描述"
      }
    ],
    "scene_002": [
      {
        "target": "scene_001",
        "type": "scene",
        "condition": "通过事件触发",
        "description": "返回场景"
      }
    ]
  },
  "room_network": {
    "room_002_001": [
      {
        "target": "room_002_002",
        "type": "room",
        "condition": "通过事件触发",
        "description": "房间连接描述"
      }
    ]
  }
}
```

**字段说明**：
- `scene_network`: 一级场景之间的连接
- `room_network`: 房间之间的连接
- `target`: 目标场景/房间ID
- `type`: 连接类型（"scene" 或 "room"）
- `condition`: 连接条件（通常是"通过事件触发"）
- `description`: 连接描述

### 3. core_events.json

核心事件列表，定义推进剧情的关键事件：

```json
[
  {
    "id": "event_001",
    "name": "事件名称",
    "description": "事件描述",
    "type": "core",
    "associated_scenes": ["scene_001"],
    "trigger_conditions": {
      "player_action": "玩家表现出帮助意愿",
      "prerequisite_events": []
    },
    "effects": {
      "scene_changes": "场景状态变化描述",
      "character_changes": {},
      "possible_transitions": ["scene_002"]
    }
  }
]
```

**字段说明**：
- `id`: 事件唯一标识符
- `name`: 事件名称
- `description`: 事件描述
- `type`: 事件类型（"core" 表示核心事件）
- `associated_scenes`: 关联的场景ID列表
- `trigger_conditions`: 触发条件
- `effects`: 事件效果

### 4. random_events.json

随机事件列表，定义可重复触发的随机事件：

```json
[
  {
    "id": "random_001",
    "name": "随机事件名称",
    "description": "随机事件描述",
    "type": "random",
    "associated_scenes": ["scene_001"],
    "trigger_conditions": {
      "random_factor": "30%概率",
      "player_action": "玩家在场景中探索"
    },
    "effects": {
      "scene_changes": "场景状态变化",
      "character_changes": {}
    }
  }
]
```

**字段说明**：
- 与核心事件类似，但 `type` 为 "random"
- 可以多次触发
- 通常不触发场景转换

### 5. monster_bindings.json（可选）

怪物绑定关系，定义哪些怪物出现在哪些场景/房间：

```json
{
  "scene_bindings": {
    "scene_002": [
      "monster_field_001"
    ]
  },
  "room_bindings": {
    "room_002_002": [
      "monster_field_001",
      "monster_field_002"
    ]
  }
}
```

**字段说明**：
- `scene_bindings`: 场景到怪物ID的映射
- `room_bindings`: 房间到怪物ID的映射

## 场景剧本文件

### 一级场景剧本格式

文件命名：`scene_{id}_{名称}.json`

```json
{
  "scene_id": "scene_001",
  "name": "场景名称",
  "scene_type": "一级场景",
  "surface": {
    "description": "场景描述文本（玩家可见）",
    "state": {
      "时间": "正午（具体时刻：约12:00）",
      "地点": {
        "区域": "区域名称",
        "具体位置": "具体位置名称",
        "坐标/方位": "坐标或方位描述",
        "环境描述": "环境描述文本"
      },
      "当前状况": "当前状况描述",
      "可见元素": ["元素1", "元素2", "元素3"]
    },
    "rooms": [
      "room_001_001",
      "room_001_002"
    ]
  },
  "hidden": {
    "director_guidance": "导演指引文本（LLM推演用）",
    "notes": {
      "events": "事件说明：事件定义存储在 core_events.json 和 random_events.json",
      "monsters": "怪物说明：怪物卡存储在 monsters/ 目录，绑定关系在 monster_bindings.json",
      "transitions": "转换说明：场景转换从 scene_network.json 中获取，必须由事件驱动"
    }
  }
}
```

**字段说明**：
- `scene_id`: 场景唯一标识符（必须与文件名前缀匹配）
- `name`: 场景可读名称
- `scene_type`: 场景类型（"一级场景"）
- `surface`: 玩家可见信息
  - `description`: 场景描述
  - `state`: 场景状态（结构化数据）
  - `rooms`: 包含的房间ID列表（如果有）
- `hidden`: LLM推演用信息
  - `director_guidance`: 导演指引
  - `notes`: 备注信息

### 二级场景（房间）剧本格式

文件命名：`room_{id}_{名称}.json`

文件位置：`scenarios/scene_{parent_id}/rooms/room_{id}_{名称}.json`

```json
{
  "room_id": "room_002_002",
  "name": "房间名称",
  "parent_scene": "scene_002",
  "scene_type": "二级场景",
  "surface": {
    "description": "房间描述文本（玩家可见）",
    "state": {
      "时间": "下午（具体时刻：约14:30，继承自主场景或独立）",
      "位置": "位置描述",
      "当前状况": "当前状况描述",
      "可见元素": ["元素1", "元素2"]
    }
  },
  "hidden": {
    "director_guidance": "导演指引文本",
    "notes": {
      "events": "事件说明",
      "monsters": "怪物说明",
      "transitions": "转换说明"
    }
  }
}
```

**字段说明**：
- `room_id`: 房间唯一标识符（必须与文件名前缀匹配）
- `name`: 房间可读名称
- `parent_scene`: 所属的一级场景ID
- 其他字段与一级场景类似

## 角色卡文件

### 重要角色卡格式

文件位置：`characters/{character_id}.json`

```json
{
  "id": "char_adventurer_001",
  "name": "角色名称",
  "description": "角色描述",
  "type": "玩家角色",
  "theme": "village_quest",
  "attributes": {
    "gender": "性别",
    "age": "年龄",
    "personality": ["性格特点1", "性格特点2"],
    "speaking_style": "说话风格",
    "background": "背景故事",
    "vitals": {
      "hp": 100,
      "mp": 50,
      "stamina": 80
    },
    "weapon": {
      "main_hand": "主手武器",
      "off_hand": "副手武器",
      "backup": "备用武器",
      "ranged": null
    },
    "equipment": {
      "armor": "护甲",
      "helmet": "头盔",
      "boots": "靴子",
      "accessory": []
    },
    "skills": ["技能1", "技能2"],
    "traits": ["特质1", "特质2"],
    "state": {
      "surface": {
        "perceived_state": "玩家可见的状态"
      },
      "hidden": {
        "observer_state": "观察者状态",
        "inner_monologue": "内心独白"
      }
    }
  },
  "created_at": "2024-01-01T00:00:00",
  "updated_at": "2024-01-01T00:00:00"
}
```

**重要提示**：
- 玩家角色必须创建角色卡
- 环境NPC不需要角色卡（它们的反应由导演评估处理）
- 详细字段说明见 `CHARACTER_ATTRIBUTES.md`

## 怪物卡文件（可选）

### 怪物卡格式

文件位置：`monsters/{monster_id}.json`

```json
{
  "id": "monster_field_001",
  "name": "怪物名称",
  "type": "怪物类型",
  "level": "难度等级",
  "description": "怪物描述",
  "attributes": {
    "hp": 150,
    "attack": 25,
    "defense": 15,
    "special_abilities": ["能力1", "能力2"]
  },
  "appearance_conditions": {
    "time_condition": "出现时间条件",
    "location_condition": "出现位置条件",
    "behavior_condition": "玩家行为条件",
    "state_condition": "状态条件",
    "random_factor": "随机概率",
    "plot_need": "剧情需要",
    "prerequisite_events": ["前置事件"]
  },
  "battle_description_template": "战斗描述模板",
  "battle_effects": {
    "on_victory": {
      "rewards": "胜利奖励",
      "scene_changes": "场景变化",
      "unlocked_events": ["解锁事件"],
      "possible_transitions": ["可能转换的场景"]
    },
    "on_defeat": {
      "consequences": "失败后果",
      "scene_changes": "场景变化",
      "possible_transitions": ["可能转换的场景"]
    }
  },
  "director_hints": {
    "when_to_appear": "何时出现",
    "how_to_describe": "如何描述",
    "battle_pacing": "战斗节奏",
    "notes": "备注"
  }
}
```

**字段说明**：
- `id`: 怪物唯一标识符
- `name`: 怪物名称
- `attributes`: 怪物属性（HP、攻击、防御等）
- `appearance_conditions`: 出现条件
- `battle_effects`: 战斗效果
- `director_hints`: 导演提示

## 创建步骤

### 步骤1：创建主题目录

```bash
mkdir themes/{theme_name}
cd themes/{theme_name}
```

### 步骤2：创建必需文件

1. 创建 `STORY_OVERVIEW.md`，定义故事背景、场景列表、重要角色
2. 创建 `scene_network.json`，定义场景连接关系
3. 创建 `core_events.json`，定义核心事件
4. 创建 `random_events.json`，定义随机事件

### 步骤3：创建场景剧本

1. 创建 `scenarios/` 目录
2. 为每个一级场景创建 `scene_{id}_{名称}.json` 文件
3. 如果场景包含房间，创建 `scenarios/scene_{id}/rooms/` 目录
4. 为每个房间创建 `room_{id}_{名称}.json` 文件

### 步骤4：创建角色卡

1. 创建 `characters/` 目录
2. 为每个重要角色（包括玩家角色）创建 `{character_id}.json` 文件

### 步骤5：创建怪物卡（可选）

1. 创建 `monsters/` 目录
2. 创建 `monster_bindings.json` 文件
3. 为每个怪物创建 `{monster_id}.json` 文件

### 步骤6：验证

1. 确保所有必需文件都存在
2. 确保场景ID、房间ID、事件ID、角色ID、怪物ID唯一且一致
3. 确保场景连接网络中的目标场景/房间存在
4. 确保事件关联的场景存在
5. 确保怪物绑定关系中的场景/房间存在

## 注意事项

1. **ID命名规范**：
   - 场景ID：`scene_001`, `scene_002`, ...
   - 房间ID：`room_{scene_id}_{number}`，如 `room_002_001`
   - 事件ID：`event_001`（核心事件），`random_001`（随机事件）
   - 角色ID：`char_{name}_{number}`
   - 怪物ID：`monster_{name}_{number}`

2. **文件命名规范**：
   - 场景文件：`scene_{id}_{可读名称}.json`
   - 房间文件：`room_{id}_{可读名称}.json`
   - 角色文件：`{character_id}.json`
   - 怪物文件：`{monster_id}.json`

3. **JSON格式要求**：
   - 使用UTF-8编码
   - 使用2空格缩进
   - 确保JSON格式正确（可以使用JSON验证工具）

4. **引用一致性**：
   - 场景连接网络中的目标必须存在
   - 事件关联的场景必须存在
   - 怪物绑定的场景/房间必须存在
   - 角色ID必须在STORY_OVERVIEW.md中定义

5. **玩家角色**：
   - 必须创建玩家角色卡
   - 玩家角色必须在STORY_OVERVIEW.md中标记为"重要角色"

## 示例主题

参考 `themes/village_quest/` 目录下的完整示例。

## 测试新主题

创建完成后，可以通过以下方式测试：

1. 启动服务器：`python app.py`
2. 使用CLI：`python cli.py`
3. 选择主题：`theme {theme_name}`
4. 执行指令：`execute {指令}`

如果遇到错误，检查：
- 文件是否存在
- JSON格式是否正确
- ID引用是否一致
- 必需字段是否完整

