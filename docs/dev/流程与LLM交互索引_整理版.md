# 流程与LLM交互索引（整理版）

本文档建立流程说明中的每一步与LLM返回格式、提供给LLM信息的对应关系。

## 流程概览

在新剧本系统中，流程中的LLM调用主要发生在以下几个步骤（按执行顺序）：

1. **Agent响应生成**（步骤4.1）：Agent考虑自身状态+玩家指令+当前环境，生成响应
2. **导演评估**（步骤6.1）：**导演评估包含两部分工作**：
   - **环境变化分析**：分析Agent响应对环境的影响，以及Agent响应的实际执行情况
   - **决策制定**：基于环境变化分析结果，决定是否触发事件、出现怪物、转换场景
   - **导演评估负责决定事件触发和统一停止点，确保所有Agent在同一时刻停止**
3. **更新Agent状态**（步骤6.5）：依据环境变化分析结果和导演决策带来的变化，更新Agent的实际状态
4. **格式化响应**（步骤8）：将原始响应转换为玩家视角文本

**环境对Agent的影响机制**：
- **Agent响应生成时**：Agent会接收**自身状态+玩家指令+当前环境状态**（场景内容、场景状态）作为输入
- **导演评估后**：环境状态会被更新（位置、时间、事件、**怪物出现**等），**更新后的环境状态会影响下一次Agent响应**
- **循环影响**：环境状态 → Agent响应 → 导演评估（环境变化分析+决策制定） → 更新Agent状态 → 更新环境状态 → 下一次Agent响应（考虑新环境状态）

**关于怪物**：
- **怪物登场后作为环境的一部分**：怪物出现后，会被记录在环境状态中，作为环境的一部分
- **状态保存在环境状态中**：怪物的状态（如HP、MP、位置等）会保存在环境状态中（如`SCENE_STATE.json`），而不是独立的角色卡文件
- **不再独立维护角色卡**：不需要为每个怪物创建独立的`{monster_id}.json`文件，怪物的状态作为环境状态的一部分进行管理
- **成本优化**：这样可以降低状态管理的复杂度，减少文件数量，但怪物状态仍然会被保存和管理

**表里区分（重要）**：
- **Agent只能看到"表"信息**：Agent接收的场景信息只包含玩家可见的描述文本和状态信息，不包含技术性标识符（场景ID、房间ID）和隐藏的游戏机制（事件触发条件、怪物出现条件等）
- **导演评估可以看到"里"信息**：导演评估器接收完整信息，包括技术性标识符、事件触发条件、怪物出现条件等隐藏信息，用于做出决策

---

## 详细索引

### 步骤1：加载场景
**流程位置**：`1. 加载场景` → `EnvironmentManager.load_scene`

**LLM交互**：无直接LLM调用

**相关信息**：
- 场景内容会作为【场景描述（玩家可见）】传递给导演评估器
- 场景状态会作为【当前场景状态】传递给导演评估器
- **Agent接收**：只接收场景的"表"部分（玩家可见的描述文本），不包含场景ID、房间ID等技术性标识符

---

### 步骤1.2：加载对话历史
**流程位置**：`1.2 加载对话历史` → `ConversationHistory.load_recent_history`

**LLM交互**：无直接LLM调用

**相关信息**：
- 对话历史会传递给Agent，用于生成角色响应
- 不会直接传递给导演评估器

---

### 步骤2：加载所有角色
**流程位置**：`2. 加载所有角色` → `CharacterStore.list_characters`

**LLM交互**：无直接LLM调用

**相关信息**：
- 角色状态会作为【角色状态】传递给导演评估器
- 角色信息会传递给Agent，用于生成角色响应（**只包含角色名和属性，不包含角色ID**）

---

### 步骤3：剧情节奏评估
**流程位置**：`3. 剧情节奏评估` → `EnvironmentAnalyzer._assess_pacing_before_action`

**LLM交互**：无直接LLM调用（基于规则判断）

**相关信息**：
- **注意**：这个步骤已被移除，统一停止点的功能由导演评估承担
- 导演评估会在Agent响应生成之后，基于Agent的实际响应决定事件触发和统一停止点

---

### 步骤4：创建智能体
**流程位置**：`4. 创建智能体` → `Agent实例化`

**LLM交互**：无直接LLM调用（准备阶段）

**相关信息**：
- Agent会使用角色信息和场景信息
- 这些信息会在步骤4.1中传递给LLM

---

### 步骤4.1：并行处理指令（LLM调用1）
**流程位置**：`4.1 并行处理指令` → `Agent.process_instruction`

**LLM交互**：**每个Agent调用LLM生成响应**

**重要**：**Agent在生成响应时会考虑：自身状态+玩家指令+当前环境**，这三个因素共同影响Agent的响应内容。

#### 提供给LLM的信息（Agent）

**信息来源**：`Agent`类的实现

**重要：Agent只能看到"表"信息，不能看到技术性标识符和"里"信息**

1. **自身状态**（**Agent的当前状态**）
   - 角色属性（从`{character_id}.json`读取，包含HP、MP、等级等数值属性）
   - 角色背景、性格、说话风格等
   - **注意**：Agent只看到角色名和属性，不看到角色ID等技术性标识符
   - **注意**：Agent接收的是角色卡中已保存的状态，不包括未确认的状态变化（`state_changes`是Agent在响应中声明的预期变化，需要经过环境变化分析确认后才会更新到角色卡中）

2. **玩家指令**
   - 玩家输入的指令

3. **当前环境**（**环境对Agent的影响体现在这里**）
   - **当前场景描述**（从场景剧本的"表"部分获取，**只包含玩家可见的描述文本**）
   - **场景状态**（从场景剧本的"表"部分的`state`字段获取，**只包含从角色视角观察到的状态信息**）
     - 包含：位置、时间、天气、环境状况等角色可以直接感知的信息
     - 包含：**角色观察到的怪物情况**（如场景描述中提到"看到一只哥布林"、"发现远处有魔物"等，从角色视角描述，不是系统层面的怪物状态列表）
     - **不包含**：系统层面的"已触发事件"列表（这可能会剧透，Agent应该通过场景描述和角色观察来感知事件，而不是直接看到事件列表）
     - **不包含**：`SCENE_STATE.json`中的`triggered_events`等系统信息
     - **不包含**：场景ID、房间ID等技术性标识符
     - **不包含**：场景剧本的"里"部分（隐藏信息、事件触发条件、怪物出现条件等）
   - **环境状态直接影响Agent的响应**：Agent会根据当前环境状态（如位置、时间、天气、角色观察到的怪物等）生成相应的响应
   - **表里区分**：Agent只能看到"表"信息（玩家可见），不能看到"里"信息（隐藏的游戏机制）
   - **角色视角**：所有信息都应该从角色视角呈现，Agent应该像角色一样观察和感知环境，而不是以系统视角看到所有信息

4. **对话历史**
   - 最近5条对话记录（从`HISTORY.json`读取）
   - **只包含"表"信息**：包含玩家指令和响应摘要（玩家可见的内容）
   - **不包含"里"信息**：不包含隐藏的状态变化、执行结果、系统层面的信息等

5. **角色剧本扩展**（如果存在）
   - 从`{character_id}_script.json`读取

#### LLM返回格式（Agent）

**返回格式**：Agent返回的响应文本（角色的想法/决策）

- 角色对话/行为描述（角色的想法和决策）
- 状态变化（state_changes）- 角色的意图/想法
- 属性变化（attribute_changes）- 角色的意图/想法

**重要**：
- **Agent只负责"产生想法"**：Agent根据观察到的信息（自身状态、玩家指令、当前环境）产生想法和决策
- **执行由导演评估负责**：Agent想法的实际执行情况由导演评估中的环境变化分析部分评估，事件/怪物/场景转换由导演评估的决策制定部分决定
- **状态更新完全依赖后续组件**：状态更新由导演评估（环境变化分析+决策制定）、状态更新器处理

**Agent响应的考虑因素**：
- **自身状态**：Agent会根据自身当前状态（HP、MP、位置、装备等）决定如何响应
- **玩家指令**：Agent会理解并执行玩家指令
- **当前环境**：Agent会根据环境状态（位置、时间、天气、角色观察到的怪物等）调整响应
- Agent的响应会反映这三个因素的综合影响（如"注意到天气变化"、"发现之前的事件痕迹"、"看到出现的怪物"等）
- **注意**：Agent不会看到系统层面的"已触发事件"列表，只能通过场景描述和角色观察来感知事件

---

### 步骤5：聚合响应
**流程位置**：`5. 聚合响应` → `ResponseAggregator.aggregate_responses`

**LLM交互**：无直接LLM调用

**相关信息**：
- 聚合所有Agent的响应
- 合并表/里信息

---

### 步骤6：分析环境变化（导演评估的第一部分）
**流程位置**：`6. 分析环境变化` → `EnvironmentManager.apply_responses_to_environment`

**LLM交互**：**作为导演评估的一部分，调用LLM分析场景变化**

**重要**：**环境变化分析是导演评估的第一部分工作，环境变化分析会更新环境状态，更新后的环境状态会影响下一次Agent响应**。

**流程定位**：
- **Agent负责"产生想法"**：Agent根据观察到的信息产生想法和决策
- **导演评估负责"环境变化分析+决策制定"**：
  - **环境变化分析**：分析Agent的想法/决策的**实际执行情况**（基于环境因素，如遇到障碍、怪物逃跑等）和对环境的影响
  - **决策制定**：基于环境变化分析结果，决定是否触发事件、让怪物出现、转换场景

**注意**：环境变化分析是导演评估的职责，作为导演评估的第一部分工作完成。

---

### 步骤6.1：导演评估阶段（LLM调用2）
**流程位置**：`6.1 导演评估阶段` → `DirectorEvaluator.evaluate_as_director`

**LLM交互**：**主要LLM调用（导演评估）**

**重要**：**导演评估包含两部分工作**：
1. **环境变化分析**（第一部分）：分析Agent响应对环境的影响，以及Agent响应的实际执行情况
2. **决策制定**（第二部分）：基于环境变化分析结果，决定是否触发事件、出现怪物、转换场景

**流程顺序**：
1. Agent响应生成（考虑自身状态+玩家指令+当前环境）
2. **导演评估**（包含环境变化分析和决策制定两部分）：
   - **环境变化分析**：分析Agent响应对环境的影响，以及实际执行情况
   - **决策制定**：基于环境变化分析结果，可能触发事件、出现怪物、转换场景。导演评估负责决定事件触发和统一停止点
3. 更新Agent实际状态（依据环境变化分析结果和导演决策带来的变化）
4. 格式化响应

#### 提供给LLM的信息

**完整信息列表**：参考`传递给LLM的信息说明.md`

**重要：导演评估可以看到完整信息，包括技术性标识符和"里"信息**

1. **【当前场景状态】**
   - 场景ID和房间ID（**技术性标识符，Agent看不到**）
   - 场景状态变化（从`SCENE_STATE.json`读取）

2. **【当前时间信息】**
   - 当前游戏时间（格式：第X天 HH:MM）
   - 进入当前场景/房间的时间
   - 在当前场景/房间的停留时间

3. **【当前事件状态】**
   - 已触发事件的数量和ID列表

4. **【玩家指令】**
   - 玩家输入的原始指令文本

5. **【Agent的想法/决策】**（最重要）
   - 每个Agent的想法/决策（Agent的响应文本，角色的想法和决策）
   - **导演需要先进行环境变化分析**：分析Agent的想法/决策对环境的影响，以及实际执行情况（成功/失败、失败原因、实际结果等）
   - **然后基于环境变化分析结果来决定事件和场景变化**

6. **【场景描述（玩家可见）】**
   - 当前场景/房间的描述（从场景剧本的"表"部分获取）

7. **【角色状态】**
   - 所有角色的属性状态（从存档文件读取）

8. **【当前场景下的可能事件（隐藏信息，仅你可见）】**
   - 核心事件列表（从`core_events.json`筛选）
   - 随机事件列表（从`random_events.json`筛选）
   - 每个事件包含：ID、名称、类型、简介、触发条件、描述预览、已触发/未触发状态
   - **这是"里"信息，Agent看不到**

9. **【潜在怪物列表（隐藏信息，仅你可见）】**
   - 当前场景/房间可能出现的怪物
   - 每个怪物包含：名称、绑定类型、出现条件、描述模板
   - **这是"里"信息，Agent看不到**

10. **【可连接目标（隐藏信息，仅你可见）】**
    - 当前场景/房间可以转换到的目标
    - 每个目标包含：ID、类型、描述、触发事件、前置条件
    - **这是"里"信息，Agent看不到**

11. **【你的任务】**
    - **第一步：环境变化分析**：仔细分析Agent响应对环境的影响，以及Agent响应的实际执行情况（成功/失败、失败原因、实际结果等）
    - **第二步：决策制定**：基于环境变化分析结果，评估是否触发事件、让怪物出现（怪物出现后作为环境的一部分，状态保存在环境状态中，不再独立维护角色卡）、转换场景/房间

12. **【场景连接网络规则】**
    - 场景连接的工作原理和规则

13. **【原则】**
    - LLM作为导演应该遵循的原则
    - **重要**：所有决策都应该基于环境变化分析结果

14. **【导演工作流程】**
    - 导演的工作步骤
    - **第一步：环境变化分析**：分析Agent响应对环境的影响，以及实际执行情况（成功/失败、失败原因、实际结果等）
    - **第二步：决策制定**：基于环境变化分析结果，评估是否触发事件、让怪物出现、转换场景

15. **【输出格式】**
    - 要求返回的JSON格式说明

#### LLM返回格式

**完整格式说明**：参考`LLM返回JSON格式详细说明.md`

```json
{
    "trigger_event": "event_001",
    "event_description": "...",
    "appear_monster": null,
    "monster_description": "",
    "transition_target": "scene_002",
    "transition_type": "scene",
    "elapsed_time": 5.0,
    "reasoning": "..."
}
```

**字段对应关系**：

| 输入信息 | 输出字段 | 说明 |
|---------|---------|------|
| **【Agent实际响应】**（最重要） | `trigger_event` | **基于环境变化分析结果**，从事件列表中选择要触发的事件ID |
| **【Agent实际响应】** | `event_description` | **基于环境变化分析结果**，生成事件描述 |
| **【Agent实际响应】** | `appear_monster` | **基于环境变化分析结果**（如提到战斗、遭遇），从怪物列表中选择要出现的怪物名称 |
| **【Agent实际响应】** | `monster_description` | **基于环境变化分析结果**，生成怪物出现描述 |
| **【Agent实际响应】** | `transition_target` | **基于环境变化分析结果**（如提到移动、到达、进入），从可连接目标中选择转换目标ID |
| 【当前场景下的可能事件】 | `trigger_event` | 从事件列表中选择要触发的事件ID（需结合环境变化分析结果） |
| 【当前场景下的可能事件】 | `event_description` | 基于事件的`description_template`生成（需结合环境变化分析结果） |
| 【潜在怪物列表】 | `appear_monster` | 从怪物列表中选择要出现的怪物名称（需结合环境变化分析结果） |
| 【潜在怪物列表】 | `monster_description` | 基于怪物的`battle_description_template`生成（需结合环境变化分析结果） |
| 【可连接目标】 | `transition_target` | 从可连接目标中选择转换目标ID（需结合环境变化分析结果） |
| 【可连接目标】 | `transition_type` | 对应目标的类型（scene/room） |
| 【当前时间信息】 | `elapsed_time` | 根据停留时间和操作复杂度估算 |
| 【你的任务】、【原则】 | `reasoning` | 基于任务和原则生成决策理由（需说明如何基于环境变化分析结果做出决策） |

**导演评估的作用**（包含两部分）：
- **第一部分：环境变化分析**
  - 分析Agent的想法/决策对环境的影响（如移动改变位置、战斗改变场景状态等）
  - 分析Agent的想法/决策的实际执行情况（基于环境因素，如遇到障碍、怪物逃跑等）
  - 生成Agent执行结果（成功/失败、失败原因、实际结果等）
  - 更新环境状态（位置、时间等）
- **第二部分：决策制定**
  - 决定事件触发：基于环境变化分析结果，决定是否触发事件
  - 决定怪物出现：基于环境变化分析结果，决定是否让怪物出现（怪物出现后作为环境的一部分，状态保存在环境状态中）
  - 决定场景转换：基于环境变化分析结果，决定是否转换场景/房间
  - 决定时间消耗：决定整体时间消耗（`elapsed_time`）
  - 统一停止点：确保所有Agent在同一时刻停止

**环境状态更新（导演评估后）**：
- 环境变化分析部分：更新环境状态（位置、时间等，基于Agent行为的影响）
- 决策制定部分：如果触发事件，会更新环境状态（记录已触发事件）
- 决策制定部分：如果出现怪物，会更新环境状态（怪物作为环境的一部分，状态保存在环境状态中）
- 决策制定部分：如果转换场景，会更新环境状态（更新场景ID、房间ID等）
- 决策制定部分：更新游戏时间（根据`elapsed_time`）

---

### 步骤6.5：更新Agent实际状态
**流程位置**：`6.5 更新Agent实际状态` → `StateUpdater.update_character_state`

**LLM交互**：无直接LLM调用

**重要**：**依据环境变化分析结果和导演决策带来的变化，更新Agent的实际状态**。

#### 更新依据

1. **环境变化分析结果**
   - Agent响应的实际执行情况
   - Agent响应对环境的影响
   - 环境对Agent响应的反馈

2. **Agent的预期状态变化**
   - Agent在响应中声明的状态变化（state_changes）
   - Agent在响应中声明的属性变化（attribute_changes）
   - Agent在响应中声明的执行结果（execution_result）

3. **导演决策带来的变化**（新增）
   - **事件触发**：如果触发事件，从事件的`effects.character_changes`中获取对Agent状态的影响
   - **怪物出现**：如果出现怪物，可能影响Agent的状态（如进入战斗状态、获得战利品、消耗资源等）
   - **场景转换**：如果转换场景，可能影响Agent的状态（如位置变化、环境适应、状态重置等）

#### 更新逻辑

- **确认Agent的实际状态变化**：根据环境变化分析结果，确认Agent的实际状态变化（可能与Agent的预期不同）
- **应用导演决策带来的变化**：根据导演评估的决策（事件触发、怪物出现、场景转换），生成对Agent状态的影响
- **合并状态变化**：将环境变化分析确认的状态变化和导演决策带来的状态变化合并
- **更新Agent状态**：将合并后的状态变化保存到Agent的状态文件中
- **更新Agent属性**：将合并后的属性变化保存到Agent的属性中

**示例1（环境变化分析）**：
- Agent预期：移动到新位置（状态变化：位置=新位置）
- 环境分析：实际遇到障碍，未能移动（实际执行情况：位置未改变）
- 更新结果：Agent的实际状态中，位置保持不变

**示例2（导演决策带来的变化 - 事件触发）**：
- 环境分析：Agent成功击败了怪物
- 导演决策：触发事件"完成清剿任务"（event_002）
- 事件效果（从`core_events.json`的`effects.character_changes`获取）："获得任务完成奖励，经验值+100，金币+50"
- 更新结果：Agent的实际状态中，任务状态更新为"已完成清剿任务"，经验值+100，金币+50

**示例3（导演决策带来的变化 - 场景转换）**：
- 导演决策：转换场景（从"村庄广场"到"田野"）
- 场景转换带来的状态变化：
  - 位置：更新为"田野"
  - 环境适应：可能需要调整状态（如从安全区域进入危险区域）
- 更新结果：Agent的实际状态中，位置和环境适应状态都被更新

**状态保存**：
- 更新后的Agent状态会保存到存档文件（`{character_id}.json`）
- 这些变化会影响下一次Agent响应时的【自身状态】信息
- 导演评估后，如果触发事件或转换场景，也会更新环境状态（怪物出现也会更新环境状态，怪物作为环境的一部分，状态保存在环境状态中，不再独立维护角色卡）

---

### 步骤8：格式化响应（LLM调用4）
**流程位置**：`8. 格式化响应` → `ResponseFormatter.format_responses_for_player`

**LLM交互**：**调用LLM转换为玩家视角文本**

#### 提供给LLM的信息

1. **Agent响应**
   - 所有Agent的原始响应（包含环境影响的响应内容）

2. **场景信息**
   - 当前场景描述（**可能包含更新后的环境状态**）

3. **格式化要求**
   - 要求转换为玩家视角
   - 合并表/里信息
   - 生成第三人称、小说风格的摘要

#### LLM返回格式

**返回格式**：格式化后的响应文本

- 玩家视角的文本描述
- 包含角色对话和行为
- 包含场景变化
- 第三人称、小说风格的摘要

**环境影响的体现**：
- 格式化后的响应会包含Agent对环境状态的响应（如"注意到天气变化"、"发现之前的事件痕迹"等）
- 场景变化会在格式化响应中体现

---

## LLM调用总结

### 主要LLM调用点

1. **Agent响应生成**（步骤4.1，LLM调用1）
   - **输入**：自身状态+玩家指令+当前环境状态（**只包含"表"信息，不包含技术性标识符和"里"信息**）、对话历史
   - **输出**：角色对话/行为描述、预期状态变化、预期属性变化、预期执行结果
   - **特点**：并行处理，每个Agent同时调用LLM
   - **对应文档**：本文档步骤4.1说明

2. **导演评估阶段**（步骤6.1，LLM调用2，最重要）
   - **输入**：Agent响应、当前场景内容、更新后的Agent状态和环境状态、事件列表（**包含"里"信息**）、怪物列表（**包含"里"信息**）、连接目标（**包含技术性标识符**）、时间信息等
   - **输出**：包含两部分
     - **环境变化分析结果**：场景变化描述（文本+JSON）、Agent响应的实际执行情况
     - **决策结果**：JSON格式的决策（事件触发、怪物出现、场景转换、时间消耗）
   - **作用**：**导演评估包含两部分工作**
     - **环境变化分析**：分析Agent响应对环境的影响，以及Agent响应的实际执行情况，更新环境状态
     - **决策制定**：基于环境变化分析结果，决定事件触发、怪物出现、场景转换。**导演评估负责决定事件触发和统一停止点，确保所有Agent在同一时刻停止**
   - **对应文档**：本文档步骤6.1说明

3. **响应格式化**（步骤8，LLM调用3）
   - **输入**：Agent响应、场景信息、玩家角色
   - **输出**：玩家视角的格式化文本、第三人称小说风格摘要
   - **对应文档**：本文档步骤8说明

### 信息流向

```
1. 加载当前环境状态和Agent状态
    ↓
2. Agent响应生成（LLM调用1）
   - 输入：自身状态+玩家指令+当前环境状态（只包含"表"信息）
   - 输出：Agent响应（包含预期状态变化）
    ↓
3. 导演评估阶段（LLM调用2，包含两部分）
   - 第一部分：环境变化分析
     - 分析Agent响应对环境的影响
     - 分析Agent响应的实际执行情况
     - 更新环境状态（位置、时间等）
   - 第二部分：决策制定
     - 输入：环境变化分析结果、事件列表（包含"里"信息）、怪物列表、连接目标（包含技术性标识符）
     - 输出：事件触发、怪物出现、场景转换决策（JSON）
     - 更新环境状态（事件、怪物、场景转换）
    ↓
4. 更新Agent实际状态
   - 依据环境变化分析结果，确认Agent的实际状态变化
   - 应用导演决策带来的变化（事件触发、怪物出现、场景转换对Agent状态的影响）
   - 更新Agent的状态和属性
    ↓
5. 格式化响应（LLM调用3）
   - 输入：Agent响应、场景信息
   - 输出：玩家视角的格式化文本
    ↓
6. 返回给玩家
    ↓
7. 保存更新后的环境状态和Agent状态
    ↓
8. 下一次循环（考虑新环境状态和自身状态）
```

## 关键对应关系

### 导演评估阶段的输入输出对应

| 输入信息 | 输出字段 | 说明 |
|---------|---------|------|
| **【Agent实际响应】**（最重要） | 环境变化分析结果 | **第一步：环境变化分析**，分析Agent响应对环境的影响和实际执行情况 |
| **环境变化分析结果** | `trigger_event` | **第二步：决策制定**，基于环境变化分析结果，从事件列表中选择要触发的事件ID |
| **环境变化分析结果** | `event_description` | **第二步：决策制定**，基于环境变化分析结果，生成事件描述 |
| **环境变化分析结果** | `appear_monster` | **第二步：决策制定**，基于环境变化分析结果（如提到战斗、遭遇），从怪物列表中选择要出现的怪物名称 |
| **环境变化分析结果** | `monster_description` | **第二步：决策制定**，基于环境变化分析结果，生成怪物出现描述 |
| **环境变化分析结果** | `transition_target` | **第二步：决策制定**，基于环境变化分析结果（如提到移动、到达、进入），从可连接目标中选择转换目标ID |
| 【当前场景下的可能事件】 | `trigger_event` | 从事件列表中选择要触发的事件ID（需结合环境变化分析结果） |
| 【当前场景下的可能事件】 | `event_description` | 基于事件的`description_template`生成（需结合环境变化分析结果） |
| 【潜在怪物列表】 | `appear_monster` | 从怪物列表中选择要出现的怪物名称（需结合环境变化分析结果） |
| 【潜在怪物列表】 | `monster_description` | 基于怪物的`battle_description_template`生成（需结合环境变化分析结果） |
| 【可连接目标】 | `transition_target` | 从可连接目标中选择转换目标ID（需结合环境变化分析结果） |
| 【可连接目标】 | `transition_type` | 对应目标的类型（scene/room） |
| 【当前时间信息】 | `elapsed_time` | 根据停留时间和操作复杂度估算 |
| 【你的任务】、【原则】 | `reasoning` | 基于任务和原则生成决策理由（需说明环境变化分析过程和基于分析结果的决策） |

### 时间信息的使用

| 时间信息 | 用途 | 影响 |
|---------|------|------|
| 当前游戏时间 | 显示给LLM当前时间状态 | 帮助LLM了解时间背景 |
| 进入时间 | 计算停留时间 | 判断事件触发条件中的时间条件 |
| 停留时间 | 评估时间条件 | 决定是否满足"在场景中停留超过X分钟"的条件 |
| elapsed_time（返回） | 更新游戏时间 | 影响后续事件触发条件的判断 |

## 环境对Agent的影响机制

### 循环影响流程

```
1. 加载当前环境状态和Agent状态
   ↓
2. Agent响应生成（LLM调用1）
   - 输入：自身状态+玩家指令+当前环境状态（只包含"表"信息）
   - Agent根据这三个因素生成响应（如"注意到天气变化"、"发现之前的事件痕迹"）
   ↓
3. 导演评估（LLM调用2，包含两部分）
   - 第一部分：环境变化分析
     - 分析Agent响应对环境的影响
     - 分析Agent响应的实际执行情况
     - 更新环境状态（位置、时间等）
   - 第二部分：决策制定
     - 基于环境变化分析结果
     - 决定事件触发、怪物出现、场景转换
     - 更新环境状态（事件、怪物、场景转换）
   ↓
4. 更新Agent实际状态
   - 依据环境变化分析结果，确认Agent的实际状态变化
   - 应用导演决策带来的变化（事件触发、怪物出现、场景转换对Agent状态的影响）
   - 更新Agent的状态和属性
   ↓
5. 保存更新后的环境状态和Agent状态
   ↓
6. 下一次Agent响应（考虑新环境状态和自身状态）
   - 输入：更新后的自身状态+玩家指令+更新后的环境状态（只包含"表"信息）
   - Agent根据这三个因素生成响应
   ↓
（循环继续）
```

### 环境状态包含的信息

- **场景描述**：当前场景的详细描述（**Agent只能看到"表"部分**）
- **场景状态**：位置、时间、天气等（**Agent只能看到从角色视角观察到的状态信息**）
- **事件感知**：Agent通过场景描述和角色观察来感知事件，**不会看到系统层面的"已触发事件"列表**（这可能会剧透）
- **出现的怪物**：怪物出现后，作为环境的一部分记录（状态如HP、MP等保存在环境状态中，不再独立维护角色卡）（**Agent只能看到角色观察到的怪物描述，如场景描述中提到"看到一只哥布林"等，看不到系统层面的怪物状态列表和出现条件**）
- **游戏时间**：当前游戏内时间（**Agent可以看到时间信息**）

### Agent状态包含的信息

- **角色属性**：HP、MP、等级、装备等
- **角色状态**：位置、任务状态、情绪状态等
- **状态变化**：经过环境变化分析确认后的实际状态变化
- **属性变化**：经过环境变化分析确认后的实际属性变化

### 环境对Agent的具体影响

1. **位置影响**：Agent会根据当前位置生成相应的响应（如在田野中会提到庄稼、在村庄会提到村民）
2. **时间影响**：Agent会根据当前时间调整行为（如夜晚会更谨慎、白天会更活跃）
3. **事件影响**：Agent会根据已发生的事件调整响应（如之前遇到魔物，现在会更警惕）
4. **状态影响**：Agent会根据场景状态调整行为（如天气变化、环境变化等）

### 环境状态和Agent状态更新时机

- **导演评估后**（包含两部分）：
  - **环境变化分析部分**：分析Agent响应对环境的影响，以及Agent响应的实际执行情况，更新环境状态（位置、时间等）
  - **决策制定部分**：如果触发事件或转换场景，会更新环境状态（事件、怪物、场景转换）
- **Agent状态更新**：依据环境变化分析结果，更新Agent的实际状态（可能与Agent的预期不同）
- **状态保存后**：更新后的环境状态和Agent状态会保存到存档，影响下一次Agent响应

### 关于怪物的处理

- **怪物出现**：导演评估决定让怪物出现后，怪物会被记录在环境状态中
- **作为环境的一部分**：怪物出现后，作为环境的一部分，状态（如HP、MP、位置等）保存在环境状态中（如`SCENE_STATE.json`）
- **不再独立维护角色卡**：不需要为每个怪物创建独立的`{monster_id}.json`文件，怪物的状态作为环境状态的一部分进行管理
- **成本优化**：这样可以降低状态管理的复杂度，减少文件数量，但怪物状态仍然会被保存和管理
- **环境描述**：怪物会在场景描述中体现，Agent可以根据环境描述感知到怪物的存在（**Agent只能看到怪物描述，不能看到怪物出现条件**）

## 表里区分说明

### Agent接收的信息（"表"信息）

Agent在生成响应时，只能接收以下"表"信息（玩家可见的信息）：

1. **场景描述**：只包含场景剧本的"表"部分（玩家可见的描述文本）
2. **场景状态**：只包含从角色视角观察到的状态信息（位置、时间、天气、角色观察到的怪物等）
   - **不包含**：系统层面的"已触发事件"列表（这可能会剧透）
   - **不包含**：系统层面的怪物状态列表（Agent只能看到场景描述中提到的怪物，如"看到一只哥布林"等）
3. **角色信息**：只包含角色名和属性，不包含角色ID等技术性标识符
4. **不包含**：场景ID、房间ID等技术性标识符
5. **不包含**：场景剧本的"里"部分（隐藏信息、事件触发条件、怪物出现条件等）
6. **不包含**：事件ID、怪物出现条件等隐藏的游戏机制
7. **不包含**：`SCENE_STATE.json`中的系统信息（如`triggered_events`等）

### 导演评估接收的信息（包含"里"信息）

导演评估器在做出决策时，可以接收完整信息，包括：

1. **场景ID和房间ID**：技术性标识符，用于场景转换
2. **事件列表**：包含事件ID、触发条件等"里"信息
3. **怪物列表**：包含怪物出现条件等"里"信息
4. **连接目标**：包含目标ID、触发事件、前置条件等"里"信息
5. **场景剧本的"里"部分**：隐藏信息、事件触发条件、怪物出现条件等

### 表里区分的重要性

- **Agent作为角色**：Agent应该像游戏中的角色一样，只能看到玩家可见的信息，不能看到隐藏的游戏机制
- **导演作为系统**：导演评估器作为系统的一部分，需要看到完整信息才能做出正确的决策
- **保持沉浸感**：表里区分可以保持游戏的沉浸感，让Agent的响应更加自然和真实

## 注意事项

1. **正确的流程顺序**：
   - Agent响应生成（考虑自身状态+玩家指令+当前环境）
   - 导演评估（包含两部分：环境变化分析+决策制定）
     - 环境变化分析：分析Agent响应对环境的影响，以及实际执行情况
     - 决策制定：基于环境变化分析结果，可能触发事件、出现怪物、转换场景
   - 更新Agent实际状态（依据环境变化分析结果和导演决策带来的变化）
   - 格式化响应（转换为玩家视角文本）

2. **导演评估阶段是核心**：这是新剧本系统的核心LLM调用，**环境变化分析和决策制定都是导演评估的职责**，所有事件触发、怪物出现、场景转换都由它决定

3. **Agent响应的考虑因素**：**Agent在生成响应时会考虑：自身状态+玩家指令+当前环境**，这三个因素共同影响Agent的响应内容

4. **环境变化分析是导演评估的第一部分**：**环境变化分析是导演评估的职责**，导演评估会先分析Agent响应对环境的影响，以及Agent响应的实际执行情况，然后更新环境状态（位置、时间等）

5. **决策制定是导演评估的第二部分**：**决策制定是导演评估的职责**，导演评估基于环境变化分析结果，决定是否触发事件、让怪物出现、转换场景，并更新环境状态（事件、怪物、场景转换）

6. **Agent状态更新**：**依据环境变化分析结果和导演决策带来的变化，更新Agent的实际状态**（可能与Agent的预期不同，且会受到导演决策的影响）

7. **导演评估的时机**：**导演评估在Agent响应生成之后进行**，包含环境变化分析和决策制定两部分工作

8. **怪物作为环境的一部分**：**怪物出现后作为环境的一部分**，状态保存在环境状态中，不再独立维护角色卡，可以降低成本

9. **信息完整性**：导演评估阶段需要完整的信息才能做出正确决策，导演评估会先进行环境变化分析，然后基于分析结果进行决策

10. **时间同步**：时间信息必须准确，因为会影响事件触发条件的判断

11. **状态更新**：每次LLM调用后，需要及时更新状态，确保下次调用时信息是最新的

12. **表里区分**：**Agent只能看到"表"信息（玩家可见），不能看到"里"信息（隐藏的游戏机制）**，这是保持游戏沉浸感的关键

---

## 发现的不合理之处及修正说明

### 1. **执行责任混乱**（已修正）

**原问题**：
- 文档说"执行由导演评估进行"，但环境变化分析已经"生成执行结果"
- 这导致执行责任不明确

**修正**：
- **环境变化分析是导演评估的职责**：环境变化分析作为导演评估的第一部分工作，分析Agent想法/决策的**实际执行情况**（基于环境因素，如遇到障碍、怪物逃跑等）
- **决策制定是导演评估的职责**：决策制定作为导演评估的第二部分工作，决定是否触发事件、让怪物出现、转换场景

### 2. **怪物出现时机不明确**（已修正）

**原问题**：
- 文档说环境变化分析会更新"出现的怪物"
- 但导演评估才决定"是否让怪物出现"
- 这有矛盾

**修正**：
- **环境变化分析（导演评估第一部分）**：分析Agent想法对环境的影响（如Agent想战斗，分析战斗对环境的影响），**不会决定怪物出现**
- **决策制定（导演评估第二部分）**：决定是否让怪物出现（基于环境变化分析结果）

### 3. **时间更新责任不明确**（已修正）

**原问题**：
- 文档说环境变化分析会更新"时间"
- 但导演评估返回`elapsed_time`
- 时间更新的责任不明确

**修正**：
- **环境变化分析（导演评估第一部分）**：分析Agent行为对时间的影响（如移动消耗时间），更新环境状态中的时间信息
- **决策制定（导演评估第二部分）**：决定整体时间消耗（`elapsed_time`），用于更新游戏时间

### 4. **环境状态更新时机不明确**（已修正）

**原问题**：
- 文档说环境变化分析后更新，导演评估后也更新
- 更新时机不明确

**修正**：
- **环境变化分析（导演评估第一部分）后**：更新环境状态（位置、时间等，基于Agent行为的影响）
- **决策制定（导演评估第二部分）后**：更新环境状态（事件、怪物、场景转换，基于导演决策）

### 5. **文档结构优化**（已修正）

**原问题**：
- 部分内容重复
- 流程说明不够清晰

**修正**：
- 明确各步骤的职责
- 优化信息流向图
- 统一术语和表述

