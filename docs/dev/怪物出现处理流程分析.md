# æ€ªç‰©å‡ºç°å¤„ç†æµç¨‹åˆ†æ

## å½“å‰æµç¨‹æ¢³ç†

### 1. å¯¼æ¼”è¯„ä¼°è¿”å›æ€ªç‰©ä¿¡æ¯

**ä½ç½®**: `services/multi_agent_coordinator.py` (298-332è¡Œ)

å¯¼æ¼”è¯„ä¼°è¿”å›ï¼š
- `director_decision.get("appear_monster", [])` - æ€ªç‰©IDåˆ—è¡¨ï¼ˆå¦‚ `["monster_field_001"]`ï¼‰
- `director_decision.get("monster_description", "")` - æ€ªç‰©æè¿°æ–‡æœ¬

### 2. æ€ªç‰©ä¿¡æ¯å¤„ç†ï¼ˆå½“å‰å®ç°ï¼‰

#### 2.1 åˆå¹¶åˆ°åœºæ™¯æè¿°ï¼ˆ303-311è¡Œï¼‰
```python
# åˆå¹¶æ€ªç‰©æè¿°åˆ°åœºæ™¯æè¿°ä¸­ï¼ˆå¦‚æœæœ‰æ€ªç‰©å‡ºç°ï¼‰
appear_monster = director_decision.get("appear_monster", [])
monster_description = director_decision.get("monster_description", "")
if appear_monster and monster_description:
    # å°†æ€ªç‰©æè¿°è¿½åŠ åˆ°åœºæ™¯æè¿°ä¸­
    if updated_scene_description:
        updated_scene_description = f"{updated_scene_description}\n\n{monster_description}"
    else:
        updated_scene_description = monster_description
```

**é—®é¢˜**: 
- `updated_scene_description` è¢«åˆå¹¶åï¼Œåªåœ¨ç¬¬327è¡Œç”¨äºæ„å»º `environment_changes["scene_changes"]["surface"]["current_narrative"]`
- è¿™ä¸ª `current_narrative` åªå–å‰200ä¸ªå­—ç¬¦ï¼Œ**æ€ªç‰©æè¿°å¯èƒ½è¢«æˆªæ–­**
- **æ²¡æœ‰ä¼ é€’åˆ°å“åº”æ ¼å¼åŒ–æµç¨‹**

#### 2.2 è®°å½•æ—¥å¿—ï¼ˆ350-357è¡Œï¼‰
```python
appear_monster = director_decision.get("appear_monster", [])
if appear_monster and ...:
    monster_desc = director_decision.get('monster_description', '')
    logger.info(f"ğŸ‘¹ æ€ªç‰©å‡ºç° ({len(appear_monster)}åª): {monster_list} - {monster_desc[:50]}")
```

**ä½œç”¨**: ä»…ç”¨äºæ—¥å¿—è®°å½•ï¼Œ**ä¸å½±å“å®é™…æ˜¾ç¤º**

#### 2.3 ä¿å­˜åˆ°åœºæ™¯çŠ¶æ€ï¼ˆ464-477è¡Œï¼‰
```python
# ä¿å­˜æ€ªç‰©ä¿¡æ¯åˆ°åœºæ™¯çŠ¶æ€
appear_monster = director_decision.get("appear_monster", [])
if appear_monster:
    monster_state = {
        "appeared_monsters": appear_monster if isinstance(appear_monster, list) else [appear_monster],
        "monster_description": director_decision.get("monster_description", "")
    }
    self.scene_state_manager.update_scene_state(
        theme,
        new_step,
        {"monsters": monster_state}
    )
```

**ä½œç”¨**: å°†æ€ªç‰©ä¿¡æ¯ä¿å­˜åˆ° `SCENE_STATE.json` çš„ `state_changes.monsters` ä¸­

**é—®é¢˜**: 
- ä¿å­˜æˆåŠŸï¼Œä½†**åç»­æ²¡æœ‰è¯»å–å’Œä½¿ç”¨**
- `environment_manager.load_scene()` **ä¸è¯»å–SCENE_STATE.jsonä¸­çš„æ€ªç‰©ä¿¡æ¯**

### 3. åœºæ™¯å†…å®¹åŠ è½½

**ä½ç½®**: `services/environment_manager.py` (20-67è¡Œ)

```python
def load_scene(self, theme: str, save_step: Optional[str] = None) -> Optional[str]:
    # è·å–å½“å‰åœºæ™¯IDå’Œæˆ¿é—´ID
    scene_id = self.scene_state_manager.get_current_scene_id(theme, save_step)
    room_id = self.scene_state_manager.get_current_room_id(theme, save_step)
    
    # åŠ è½½åœºæ™¯å‰§æœ¬JSON
    if room_id:
        room_script = self.script_manager.load_room_script(theme, room_id)
        surface = room_script.get("surface", {})
        description = surface.get("description", "")
        state = surface.get("state", {})
        scene_content = self._build_scene_content(description, state, room_id, scene_id)
    else:
        scene_script = self.script_manager.load_scene_script(theme, scene_id)
        surface = scene_script.get("surface", {})
        description = surface.get("description", "")
        state = surface.get("state", {})
        scene_content = self._build_scene_content(description, state, None, scene_id)
```

**é—®é¢˜**: 
- **åªä»åœºæ™¯å‰§æœ¬JSONåŠ è½½**ï¼Œä¸è¯»å– `SCENE_STATE.json` ä¸­çš„æ€ªç‰©ä¿¡æ¯
- `_build_scene_content()` åªä½¿ç”¨åœºæ™¯å‰§æœ¬çš„ `description` å’Œ `state`ï¼Œ**ä¸åŒ…å«æ€ªç‰©ä¿¡æ¯**

### 4. å“åº”æ ¼å¼åŒ–

**ä½ç½®**: `services/multi_agent_coordinator.py` (509-528è¡Œ)

```python
# å¦‚æœæ²¡æœ‰Agentå“åº”ï¼Œä½†å¯¼æ¼”è¯„ä¼°è¿”å›äº†æ›´æ–°çš„åœºæ™¯æè¿°ï¼ˆåŒ…å«ç¯å¢ƒNPCçš„ååº”ï¼‰ï¼Œ
# åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå“åº”æ¥åŒ…å«è¿™äº›å†…å®¹
if not agent_responses and updated_scene_description:
    virtual_response = {
        'character_id': 'environment_npc',
        'character_name': 'ç¯å¢ƒ',
        'response': updated_scene_description,  # è¿™é‡Œåº”è¯¥åŒ…å«æ€ªç‰©æè¿°
        ...
    }
    agent_responses = [virtual_response]

formatted = self.response_formatter.format_responses_for_player(
    agent_responses,
    player_role or 'ç©å®¶',
    scene_content,  # åœºæ™¯å†…å®¹ï¼ˆä¸åŒ…å«æ€ªç‰©ä¿¡æ¯ï¼‰
    platform
)
```

**é—®é¢˜**: 
- `updated_scene_description` åœ¨ç¬¬299è¡Œè·å–ï¼Œåœ¨ç¬¬303-311è¡Œåˆå¹¶æ€ªç‰©æè¿°
- ä½†**è¿™ä¸ªå˜é‡åªåœ¨ç¬¬511è¡Œä½¿ç”¨**ï¼ˆå½“æ²¡æœ‰agentå“åº”æ—¶ï¼‰
- **å¦‚æœæœ‰agentå“åº”ï¼Œæ€ªç‰©æè¿°ä¸ä¼šè¢«ä¼ é€’åˆ°å“åº”æ ¼å¼åŒ–ä¸­**

## é—®é¢˜æ€»ç»“

1. **æ€ªç‰©æè¿°è¢«æˆªæ–­**: `current_narrative` åªå–å‰200ä¸ªå­—ç¬¦
2. **æ€ªç‰©æè¿°æœªä¼ é€’**: åˆå¹¶åçš„ `updated_scene_description` åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ä½¿ç”¨
3. **åœºæ™¯å†…å®¹ä¸åŒ…å«æ€ªç‰©**: `load_scene()` ä¸è¯»å– `SCENE_STATE.json` ä¸­çš„æ€ªç‰©ä¿¡æ¯
4. **æ€ªç‰©ä¿¡æ¯ä¿å­˜ä½†æœªä½¿ç”¨**: è™½ç„¶ä¿å­˜åˆ° `SCENE_STATE.json`ï¼Œä½†åç»­æµç¨‹ä¸è¯»å–

## è§£å†³æ–¹æ¡ˆå»ºè®®

### æ–¹æ¡ˆ1: åœ¨åœºæ™¯å†…å®¹åŠ è½½æ—¶åˆå¹¶æ€ªç‰©ä¿¡æ¯ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `environment_manager.load_scene()` å’Œ `_build_scene_content()`ï¼š
1. è¯»å– `SCENE_STATE.json` ä¸­çš„æ€ªç‰©ä¿¡æ¯
2. å°†æ€ªç‰©æè¿°åˆå¹¶åˆ°åœºæ™¯æè¿°ä¸­
3. åœ¨åœºæ™¯çŠ¶æ€ä¸­æ˜¾ç¤ºæ€ªç‰©ä¿¡æ¯

### æ–¹æ¡ˆ2: åœ¨å“åº”æ ¼å¼åŒ–æ—¶åˆå¹¶æ€ªç‰©ä¿¡æ¯

ä¿®æ”¹ `multi_agent_coordinator.py` çš„å“åº”æ ¼å¼åŒ–éƒ¨åˆ†ï¼š
1. è¯»å– `SCENE_STATE.json` ä¸­çš„æ€ªç‰©ä¿¡æ¯
2. å°†æ€ªç‰©æè¿°åˆå¹¶åˆ° `scene_content` æˆ– `agent_responses` ä¸­
3. ä¼ é€’ç»™å“åº”æ ¼å¼åŒ–å™¨

### æ–¹æ¡ˆ3: ç¡®ä¿updated_scene_descriptionè¢«æ­£ç¡®ä¼ é€’

ä¿®æ”¹ `multi_agent_coordinator.py`ï¼š
1. ç¡®ä¿åˆå¹¶åçš„ `updated_scene_description` è¢«ä¼ é€’åˆ°å“åº”æ ¼å¼åŒ–
2. æ— è®ºæ˜¯å¦æœ‰agentå“åº”ï¼Œéƒ½åŒ…å«æ€ªç‰©æè¿°

## å½“å‰SCENE_STATE.jsonç»“æ„

```json
{
  "scene_id": "scene_002",
  "room_id": null,
  "state_changes": {
    "enter_time": 600.0,
    "monsters": {
      "appeared_monsters": ["monster_field_001"],
      "monster_description": "ä¸€åªå¤§å‹é‡å…½ä»åº„ç¨¼ä¸­çŒ›ç„¶å†²å‡º..."
    }
  },
  "triggered_events": []
}
```

**ç¡®è®¤**: æ€ªç‰©ä¿¡æ¯å·²æ­£ç¡®ä¿å­˜ï¼Œä½†**æ²¡æœ‰è¢«è¯»å–å’Œä½¿ç”¨**ã€‚

