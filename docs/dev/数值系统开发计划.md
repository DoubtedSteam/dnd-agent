# DND风格数值系统开发计划

## 一、项目概述

### 1.1 目标
建立一个基于**DND 5e（龙与地下城第五版）**规则的完整数值系统，包括属性系统、d20掷骰战斗、技能检定、豁免检定等核心机制。

### 1.2 DND 5e核心规则概述
- **6大基础属性**：力量(STR)、敏捷(DEX)、体质(CON)、智力(INT)、感知(WIS)、魅力(CHA)
- **属性值范围**：通常1-20（玩家角色通常8-15）
- **属性调整值**：`(属性值 - 10) / 2`，向下取整
- **d20掷骰系统**：所有检定使用20面骰子
- **AC（护甲等级）**：10 + DEX调整值 + 护甲加值
- **熟练加值**：随等级增长（+2到+6）
- **攻击检定**：d20 + 属性调整值 + 熟练加值 vs AC
- **伤害计算**：武器伤害骰 + 属性调整值
- **技能检定**：d20 + 属性调整值 + 熟练加值（如果熟练）
- **豁免检定**：d20 + 属性调整值 + 熟练加值（如果熟练）

### 1.3 现状分析
**已有基础：**
- ✅ 角色基础属性：HP、MP、Stamina
- ✅ 怪物基础属性：HP、Attack、Defense
- ✅ 武器和装备槽位系统（名称）
- ✅ 技能列表（名称）

**缺失功能：**
- ❌ DND属性系统（6大属性 + 调整值）
- ❌ d20掷骰系统
- ❌ AC（护甲等级）计算
- ❌ 熟练加值系统
- ❌ 攻击检定和伤害计算
- ❌ 技能检定系统
- ❌ 豁免检定系统
- ❌ 武器伤害骰系统
- ❌ 状态效果系统（Buff/Debuff）
- ❌ 经验值和等级系统
- ❌ 属性成长系统

---

## 二、系统架构设计

### 2.1 核心模块划分（DND风格）

```
DND数值系统 (DNDNumericSystem)
├── 属性系统 (AttributeSystem)
│   ├── 6大基础属性管理（STR, DEX, CON, INT, WIS, CHA）
│   ├── 属性调整值计算（Modifier）
│   ├── 属性值验证（1-20范围，可扩展至30）
│   └── 属性成长（每4级+2点）
├── 掷骰系统 (DiceSystem)
│   ├── d20掷骰核心
│   ├── 多面骰支持（d4, d6, d8, d10, d12, d20, d100）
│   ├── 优势/劣势掷骰
│   └── 掷骰结果记录
├── 战斗系统 (CombatSystem)
│   ├── AC（护甲等级）计算
│   ├── 攻击检定（d20 + 属性调整值 + 熟练加值）
│   ├── 伤害计算（武器伤害骰 + 属性调整值）
│   ├── 暴击判定（自然20）
│   └── 战斗流程管理
├── 熟练系统 (ProficiencySystem)
│   ├── 熟练加值计算（随等级增长）
│   ├── 武器熟练
│   ├── 技能熟练
│   └── 豁免熟练
├── 技能检定系统 (SkillCheckSystem)
│   ├── 技能列表（18项技能）
│   ├── 技能检定（d20 + 属性调整值 + 熟练加值）
│   ├── 技能难度等级（DC）
│   └── 技能检定结果判定
├── 豁免检定系统 (SavingThrowSystem)
│   ├── 6大豁免检定（对应6大属性）
│   ├── 豁免检定（d20 + 属性调整值 + 熟练加值）
│   └── 豁免难度等级（DC）
├── 装备系统 (EquipmentSystem)
│   ├── 武器系统（伤害骰、属性、类型）
│   ├── 护甲系统（AC加值、类型、限制）
│   ├── 装备效果计算
│   └── 装备槽位管理
├── 法术系统 (SpellSystem)
│   ├── 法术位管理
│   ├── 法术检定（攻击检定或豁免检定）
│   ├── 法术伤害计算
│   └── 法术持续时间
├── 状态效果系统 (StatusEffectSystem)
│   ├── Buff/Debuff管理
│   ├── 持续时间追踪（回合/分钟/小时）
│   ├── 效果叠加规则
│   └── 状态移除
└── 成长系统 (GrowthSystem)
    ├── 经验值计算（CR-based）
    ├── 等级提升
    ├── 熟练加值增长
    ├── 属性成长（每4级+2）
    └── HP成长（职业生命骰 + CON调整值）
```

---

## 三、详细开发计划

### 阶段一：核心数据结构设计（优先级：高）

#### 3.1 DND属性系统

**文件：** `services/numeric_system/attribute_system.py`

**任务：**
1. 定义DND 6大基础属性
   - **力量(STR)**：影响近战攻击、伤害、力量检定
   - **敏捷(DEX)**：影响AC、远程攻击、先攻、敏捷检定
   - **体质(CON)**：影响HP、体质检定
   - **智力(INT)**：影响法术攻击、智力检定
   - **感知(WIS)**：影响感知检定、被动感知
   - **魅力(CHA)**：影响社交、魅力检定

2. 属性调整值计算
   ```python
   def calculate_modifier(ability_score: int) -> int:
       """计算属性调整值：floor((属性值 - 10) / 2)"""
       return (ability_score - 10) // 2
   ```
   - 属性值 1 → 调整值 -5
   - 属性值 10 → 调整值 0
   - 属性值 15 → 调整值 +2
   - 属性值 20 → 调整值 +5

3. 属性值范围
   - 标准范围：1-20
   - 可扩展至30（传奇角色）
   - 属性值验证函数

**输出：**
- `AttributeSystem` 类
- `calculate_modifier()` 函数
- `validate_ability_score()` 函数
- `get_all_modifiers()` 函数

#### 3.2 掷骰系统

**文件：** `services/numeric_system/dice_system.py`

**任务：**
1. 实现多面骰系统
   - d4, d6, d8, d10, d12, d20, d100
   - 支持多骰子（如2d6、3d8）
   - 支持加值（如d20+5）

2. 优势/劣势系统
   - 优势：掷两次d20，取较高值
   - 劣势：掷两次d20，取较低值

3. 掷骰结果记录
   - 记录原始掷骰值
   - 记录最终结果（含加值）
   - 记录是否暴击（自然20/自然1）

**输出：**
- `DiceSystem` 类
- `roll_dice()` 函数
- `roll_with_advantage()` 函数
- `roll_with_disadvantage()` 函数

#### 3.3 熟练系统

**文件：** `services/numeric_system/proficiency_system.py`

**任务：**
1. 熟练加值计算
   - 1-4级：+2
   - 5-8级：+3
   - 9-12级：+4
   - 13-16级：+5
   - 17-20级：+6

2. 熟练类型管理
   - 武器熟练（近战/远程）
   - 技能熟练（18项技能）
   - 豁免熟练（6大豁免）

**输出：**
- `ProficiencySystem` 类
- `get_proficiency_bonus()` 函数
- `is_proficient()` 函数

#### 3.4 装备数值结构设计（DND风格）

**文件：** `services/numeric_system/equipment_system.py`

**任务：**
1. 武器JSON结构（DND风格）
   ```json
   {
     "id": "weapon_longsword",
     "name": "长剑",
     "type": "martial_melee",
     "damage_dice": "1d8",
     "damage_type": "slashing",
     "properties": ["versatile"],
     "versatile_damage": "1d10",
     "range": null,
     "weight": 3,
     "cost": 15
   }
   ```

2. 护甲JSON结构（DND风格）
   ```json
   {
     "id": "armor_leather",
     "name": "皮甲",
     "type": "light_armor",
     "ac": 11,
     "max_dex_bonus": null,
     "stealth_disadvantage": false,
     "weight": 10,
     "cost": 10
   }
   ```

3. 装备类型定义
   - 武器：简易近战、军用近战、简易远程、军用远程
   - 护甲：轻甲、中甲、重甲、盾牌

**输出：**
- 装备数据结构定义
- AC计算函数
- 装备加载和验证函数

#### 3.5 技能检定系统

**文件：** `services/numeric_system/skill_check_system.py`

**任务：**
1. DND 18项技能定义
   - **力量**：运动(Athletics)
   - **敏捷**：体操(Acrobatics)、巧手(Sleight of Hand)、潜行(Stealth)
   - **智力**：奥秘(Arcana)、历史(History)、调查(Investigation)、自然(Nature)、宗教(Religion)
   - **感知**：驯兽(Animal Handling)、洞察(Insight)、医药(Medicine)、察觉(Perception)、生存(Survival)
   - **魅力**：欺瞒(Deception)、威吓(Intimidation)、表演(Performance)、游说(Persuasion)

2. 技能检定计算
   ```
   技能检定 = d20 + 对应属性调整值 + 熟练加值（如果熟练）
   ```

3. 难度等级（DC）
   - 非常简单：5
   - 简单：10
   - 中等：15
   - 困难：20
   - 极难：25
   - 几乎不可能：30

**输出：**
- `SkillCheckSystem` 类
- `make_skill_check()` 函数
- `get_skill_modifier()` 函数

#### 3.6 豁免检定系统

**文件：** `services/numeric_system/saving_throw_system.py`

**任务：**
1. 6大豁免检定
   - 力量豁免、敏捷豁免、体质豁免
   - 智力豁免、感知豁免、魅力豁免

2. 豁免检定计算
   ```
   豁免检定 = d20 + 对应属性调整值 + 熟练加值（如果熟练）
   ```

**输出：**
- `SavingThrowSystem` 类
- `make_saving_throw()` 函数

---

### 阶段二：战斗计算引擎（优先级：高）

#### 3.7 AC（护甲等级）计算

**文件：** `services/numeric_system/combat_system.py`

**任务：**
1. AC计算公式
   ```
   基础AC = 10 + DEX调整值
   轻甲AC = 护甲基础AC + DEX调整值（无上限）
   中甲AC = 护甲基础AC + DEX调整值（最高+2）
   重甲AC = 护甲基础AC（不受DEX影响）
   盾牌 = +2 AC
   ```

2. AC计算函数
   - 考虑护甲类型
   - 考虑DEX调整值限制
   - 考虑盾牌加成

**输出：**
- `calculate_ac()` 函数

#### 3.8 攻击检定系统

**任务：**
1. 攻击检定计算
   ```
   攻击检定 = d20 + 属性调整值（STR或DEX）+ 熟练加值（如果熟练）
   命中条件：攻击检定 >= 目标AC
   ```

2. 武器属性判定
   - 近战武器：使用STR调整值
   - 远程武器：使用DEX调整值
   - 灵巧武器：可选择STR或DEX

3. 暴击判定
   - 自然20：自动命中并暴击
   - 自然1：自动未命中

**输出：**
- `make_attack_roll()` 函数
- `check_hit()` 函数
- `check_critical()` 函数

#### 3.9 伤害计算系统

**任务：**
1. 伤害计算公式
   ```
   基础伤害 = 武器伤害骰（如1d8）
   属性加值 = STR调整值（近战）或DEX调整值（远程/灵巧）
   最终伤害 = 基础伤害 + 属性加值
   暴击伤害 = 所有伤害骰翻倍 + 属性加值
   ```

2. 伤害类型
   - 挥砍(Slashing)
   - 穿刺(Piercing)
   - 钝击(Bludgeoning)
   - 火焰、寒冷、闪电、毒素等

**输出：**
- `calculate_damage()` 函数
- `roll_weapon_damage()` 函数

#### 3.10 战斗流程管理

**任务：**
1. 先攻判定
   ```
   先攻 = d20 + DEX调整值
   ```

2. 战斗回合管理
   - 行动顺序（按先攻排序）
   - 行动执行（移动、动作、附赠动作）
   - 状态效果应用

3. 战斗结果计算
   - 伤害应用
   - HP更新
   - 状态更新

**输出：**
- `roll_initiative()` 函数
- `execute_combat_action()` 函数
- `process_combat_turn()` 函数

---

### 阶段三：状态效果和法术系统（优先级：中）

#### 3.11 状态效果系统（DND风格）

**文件：** `services/numeric_system/status_effect_system.py`

**任务：**
1. DND状态效果定义
   - 目盲、魅惑、耳聋、力竭、恐慌、擒抱、失能、隐形、石化、中毒、倒地、束缚、震慑、昏迷等

2. 状态效果数据结构
   ```json
   {
     "id": "condition_poisoned",
     "name": "中毒",
     "type": "condition",
     "duration": {
       "type": "rounds",
       "value": 3
     },
     "effects": {
       "disadvantage_on_attack_rolls": true,
       "disadvantage_on_ability_checks": true
     }
   }
   ```

3. 状态效果管理
   - 状态应用
   - 持续时间追踪（回合/分钟/小时/专注）
   - 效果叠加规则
   - 状态移除（豁免成功/时间到期）

**输出：**
- `StatusEffectSystem` 类
- `apply_condition()` 函数
- `update_conditions()` 函数
- `remove_condition()` 函数

#### 3.12 法术系统

**文件：** `services/numeric_system/spell_system.py`

**任务：**
1. 法术位管理
   - 1-9环法术位
   - 法术位消耗和恢复

2. 法术攻击检定
   ```
   法术攻击 = d20 + 施法属性调整值 + 熟练加值
   ```

3. 法术豁免检定
   ```
   目标豁免 = d20 + 对应属性调整值 + 熟练加值（如果熟练）
   成功：减半伤害或无效果
   失败：全额伤害或完全效果
   ```

4. 法术持续时间
   - 立即、1回合、1分钟、10分钟、1小时、8小时、24小时
   - 专注：需要维持专注，受伤需做专注检定

**输出：**
- `SpellSystem` 类
- `cast_spell()` 函数
- `make_spell_attack()` 函数
- `check_spell_save()` 函数

---

### 阶段四：成长系统（优先级：中）

#### 3.13 经验值和等级系统（DND风格）

**文件：** `services/numeric_system/growth_system.py`

**任务：**
1. DND经验值表
   - 1级：0 XP
   - 2级：300 XP
   - 3级：900 XP
   - 4级：2700 XP
   - 5级：6500 XP
   - ...（完整1-20级经验值表）

2. 经验值获得
   - 击败怪物：根据CR（挑战等级）获得经验
   - 完成任务：DM分配经验
   - 经验值分配（多人时平均分配）

3. 等级提升
   - 等级提升判定
   - 熟练加值增长（每4级+1）
   - 属性成长（每4级+2，可分配到任意属性）
   - HP成长：职业生命骰 + CON调整值（至少+1）

**输出：**
- `GrowthSystem` 类
- `calculate_exp_gain()` 函数（基于CR）
- `check_level_up()` 函数
- `apply_level_up()` 函数
- `roll_hit_dice()` 函数（HP成长）

---

### 阶段五：系统集成（优先级：高）

#### 3.8 与现有系统集成

**任务：**
1. 集成到角色系统
   - 修改 `CharacterStore` 支持新属性结构
   - 更新角色JSON格式

2. 集成到导演评估系统
   - 在战斗判定中使用数值系统
   - 在环境变化分析中应用战斗结果

3. 集成到怪物系统
   - 扩展怪物JSON支持完整属性
   - 怪物战斗计算

**文件修改：**
- `services/character_store.py`
- `services/director_evaluator.py`
- `themes/*/monsters/*.json`（扩展格式）

---

### 阶段六：数据文件更新（优先级：中）

#### 3.9 更新现有数据文件

**任务：**
1. 更新角色模板
   - 添加基础属性值
   - 添加装备数值
   - 添加技能数值

2. 更新怪物模板
   - 完善怪物属性
   - 添加怪物技能

3. 创建装备库
   - 定义常用武器
   - 定义常用防具
   - 定义特殊装备

**文件：**
- `themes/*/characters/*.json`
- `themes/*/monsters/*.json`
- `themes/*/equipment/*.json`（新建）

---

## 四、技术实现细节

### 4.1 文件结构

```
services/
├── numeric_system/
│   ├── __init__.py
│   ├── attribute_system.py      # 属性系统
│   ├── combat_system.py          # 战斗系统
│   ├── equipment_system.py      # 装备系统
│   ├── skill_system.py          # 技能系统
│   ├── status_effect_system.py  # 状态效果系统
│   └── growth_system.py         # 成长系统
```

### 4.2 数据格式规范（DND风格）

#### 角色属性扩展格式
```json
{
  "attributes": {
    "ability_scores": {
      "str": 15,  // 力量（1-20）
      "dex": 13,  // 敏捷
      "con": 14,  // 体质
      "int": 12,  // 智力
      "wis": 10,  // 感知
      "cha": 8    // 魅力
    },
    "ability_modifiers": {
      "str": 2,   // 力量调整值（自动计算）
      "dex": 1,   // 敏捷调整值
      "con": 2,   // 体质调整值
      "int": 1,   // 智力调整值
      "wis": 0,   // 感知调整值
      "cha": -1   // 魅力调整值
    },
    "proficiencies": {
      "weapons": ["simple_melee", "martial_melee"],
      "skills": ["athletics", "perception", "survival"],
      "saving_throws": ["str", "con"]
    },
    "proficiency_bonus": 2,  // 熟练加值（根据等级）
    "ac": 16,  // 护甲等级（计算得出）
    "initiative": 1,  // 先攻加值（DEX调整值）
    "vitals": {
      "max_hp": 12,
      "current_hp": 12,
      "hit_dice": "1d10",  // 职业生命骰
      "hit_dice_remaining": 1,
      "max_mp": 0,  // 法术位（如果有）
      "current_mp": 0,
      "spell_slots": {
        "1": 0,
        "2": 0,
        "3": 0
      }
    },
    "level": 1,
    "experience": 0,
    "class": "fighter",  // 职业
    "background": "soldier"  // 背景
  }
}
```

### 4.3 API设计（DND风格）

#### 属性系统API
```python
class AttributeSystem:
    def calculate_modifier(self, ability_score: int) -> int
    def get_all_modifiers(self, character: Dict) -> Dict
    def validate_ability_score(self, score: int) -> bool
```

#### 掷骰系统API
```python
class DiceSystem:
    def roll_dice(self, dice: str) -> int  # "1d20", "2d6+3"
    def roll_with_advantage(self) -> int
    def roll_with_disadvantage(self) -> int
    def roll_d20(self, modifier: int = 0) -> Dict
```

#### 熟练系统API
```python
class ProficiencySystem:
    def get_proficiency_bonus(self, level: int) -> int
    def is_proficient(self, character: Dict, proficiency_type: str, item: str) -> bool
```

#### 战斗系统API
```python
class CombatSystem:
    def calculate_ac(self, character: Dict) -> int
    def make_attack_roll(self, attacker: Dict, weapon: Dict, target_ac: int) -> Dict
    def calculate_damage(self, attacker: Dict, weapon: Dict, is_critical: bool = False) -> int
    def roll_initiative(self, character: Dict) -> int
```

#### 技能检定系统API
```python
class SkillCheckSystem:
    def make_skill_check(self, character: Dict, skill: str, dc: int, advantage: bool = False) -> Dict
    def get_skill_modifier(self, character: Dict, skill: str) -> int
```

#### 豁免检定系统API
```python
class SavingThrowSystem:
    def make_saving_throw(self, character: Dict, ability: str, dc: int) -> Dict
```

---

## 五、开发优先级和时间估算

### 优先级排序

1. **P0（必须）**：属性系统、战斗计算引擎、系统集成
2. **P1（重要）**：装备系统、技能系统
3. **P2（可选）**：状态效果系统、成长系统

### 时间估算

- **阶段一**：2-3天（数据结构设计）
- **阶段二**：3-4天（战斗计算引擎）
- **阶段三**：2-3天（状态效果系统）
- **阶段四**：2天（成长系统）
- **阶段五**：2-3天（系统集成）
- **阶段六**：1-2天（数据文件更新）

**总计：** 12-17天

---

## 六、测试计划

### 6.1 单元测试

- 属性计算测试
- 伤害计算测试
- 命中判定测试
- 暴击判定测试
- 状态效果测试

### 6.2 集成测试

- 完整战斗流程测试
- 装备效果测试
- 技能使用测试
- 等级提升测试

### 6.3 平衡性测试

- 伤害数值平衡
- 属性成长平衡
- 技能强度平衡

---

## 七、后续扩展方向

1. **装备强化系统**：装备升级、附魔
2. **技能树系统**：技能学习、技能升级
3. **属性点分配**：玩家自定义属性成长
4. **战斗AI**：智能战斗决策
5. **战斗动画系统**：可视化战斗过程

---

## 八、注意事项

1. **向后兼容**：确保现有角色数据可以平滑迁移
2. **数据验证**：所有数值计算都需要输入验证
3. **性能优化**：战斗计算需要高效，避免影响游戏流畅度
4. **可配置性**：数值公式应该可配置，便于平衡调整
5. **日志记录**：重要数值计算需要记录日志，便于调试

---

## 九、DND 5e核心规则参考

### 9.1 属性调整值表
| 属性值 | 调整值 | 属性值 | 调整值 | 属性值 | 调整值 |
|--------|--------|--------|--------|--------|--------|
| 1      | -5     | 8-9    | -1     | 16-17  | +3     |
| 2-3    | -4     | 10-11  | 0      | 18-19  | +4     |
| 4-5    | -3     | 12-13  | +1     | 20-21  | +5     |
| 6-7    | -2     | 14-15  | +2     | 22-23  | +6     |

### 9.2 熟练加值表
| 等级 | 熟练加值 | 等级 | 熟练加值 |
|------|----------|------|----------|
| 1-4  | +2       | 13-16| +5       |
| 5-8  | +3       | 17-20| +6       |
| 9-12 | +4       |      |          |

### 9.3 经验值表（1-10级）
| 等级 | 经验值 | 等级 | 经验值 |
|------|--------|------|--------|
| 1    | 0      | 6    | 14000  |
| 2    | 300    | 7    | 23000  |
| 3    | 900    | 8    | 34000  |
| 4    | 2700   | 9    | 48000  |
| 5    | 6500   | 10   | 64000  |

### 9.4 常见武器示例
- **长剑**：1d8挥砍，灵巧，可双手1d10
- **短剑**：1d6穿刺，灵巧，轻武器
- **长弓**：1d8穿刺，弹药，射程150/600
- **匕首**：1d4穿刺，灵巧，轻武器，投掷

### 9.5 常见护甲示例
- **无甲**：AC = 10 + DEX调整值
- **皮甲**：AC = 11 + DEX调整值（轻甲）
- **链甲衫**：AC = 13 + DEX调整值（最高+2）（中甲）
- **板甲**：AC = 18（重甲，不受DEX影响）

---

## 十、参考资料

- **DND 5e官方规则**：玩家手册（Player's Handbook）
- 现有代码：`services/director_evaluator.py`、`themes/*/characters/*.json`、`themes/*/monsters/*.json`
- 属性文档：`CHARACTER_ATTRIBUTES.md`
- 流程文档：`docs/dev/每轮游戏流程说明.md`

