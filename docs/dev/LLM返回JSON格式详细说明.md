# LLM返回JSON格式详细说明

## 概述

本文档详细说明导演评估器（DirectorEvaluator）要求LLM返回的JSON格式。LLM作为剧情导演，需要评估当前状态并返回决策结果，包括事件触发、怪物出现、场景转换和时间消耗等信息。

**重要**：LLM的所有决策都应该**基于Agent的实际响应**，而不仅仅是玩家指令。Agent的响应、状态变化和属性变化是导演评估的重要依据。

## JSON返回格式

### 完整格式

```json
{
    "trigger_event": "event_001",
    "event_description": "年长的村民注意到你，走过来向你求助：\"冒险者，我们的田野被魔物侵扰，庄稼被毁，村民们都不敢去田里了。你能帮我们清剿这些魔物吗？我们会给予报酬的。\"",
    "appear_monster": null,
    "monster_description": "",
    "transition_target": "scene_002",
    "transition_type": "scene",
    "elapsed_time": 5.0,
    "reasoning": "玩家表现出帮助意愿，且已满足事件触发条件（在场景中停留超过5分钟），应该触发接受任务事件并引导玩家前往田野"
}
```

## 字段详细说明

### 1. trigger_event

- **类型**: `string | null`
- **必填**: 是
- **说明**: 触发的事件ID
- **格式要求**: 
  - 必须使用事件ID，不能使用事件名称
  - 核心事件格式：`"event_001"`, `"event_002"`, ...
  - 随机事件格式：`"random_001"`, `"random_002"`, ...
  - 如果不触发事件，必须为 `null`
- **示例**: 
  - `"event_001"` - 触发核心事件"接受清剿任务"
  - `"random_003"` - 触发随机事件"遭遇魔物"
  - `null` - 不触发任何事件
- **注意事项**:
  - **必须基于Agent的实际响应**来决定是否触发事件
  - 事件ID必须存在于当前场景的潜在事件列表中
  - 必须检查事件的前置条件是否满足
  - 核心事件可以触发场景转换，随机事件不能触发场景转换
  - 如果Agent响应中提到了相关行为（如"接受任务"、"前往田野"等），应该考虑触发对应的事件

### 2. event_description

- **类型**: `string`
- **必填**: 是（如果trigger_event不为null）
- **说明**: 事件描述文本，用于向玩家展示
- **格式要求**:
  - 如果触发事件，必须提供完整的描述文本
  - 如果不触发事件（trigger_event为null），可以为空字符串 `""`
  - 描述应该生动、符合剧情逻辑
  - 可以使用事件定义中的`description_template`作为参考，但应该根据当前情况调整
- **示例**: 
  - `"年长的村民注意到你，走过来向你求助：\"冒险者，我们的田野被魔物侵扰...\""`
  - `""` - 不触发事件时为空字符串
- **注意事项**:
  - **描述应该与Agent的实际响应相关**，反映Agent的行为和状态变化
  - 描述应该与事件类型和当前场景状态匹配
  - 应该包含足够的细节，让玩家感受到事件的真实性
  - 如果Agent响应中提到了特定行为，事件描述应该与之呼应

### 3. appear_monster

- **类型**: `string | null`
- **必填**: 是
- **说明**: 出现的怪物名称
- **格式要求**:
  - 使用怪物名称（如 `"田野魔物"`）
  - 怪物名称必须存在于当前场景/房间的潜在怪物列表中
  - 如果不出现怪物，必须为 `null`
- **示例**: 
  - `"田野魔物"` - 怪物出现
  - `null` - 不出现怪物
- **注意事项**:
  - **必须基于Agent的实际响应**来决定是否让怪物出现
  - 怪物必须与当前场景/房间绑定
  - 必须检查怪物的出现条件是否满足
  - 怪物出现通常与战斗事件相关
  - 如果Agent响应中提到了战斗、遭遇、发现敌人等，应该考虑让怪物出现

### 4. monster_description

- **类型**: `string`
- **必填**: 是（如果appear_monster不为null）
- **说明**: 怪物出现描述文本，用于向玩家展示
- **格式要求**:
  - 如果怪物出现，必须提供完整的描述文本
  - 如果不出现怪物（appear_monster为null），可以为空字符串 `""`
  - 描述应该生动、营造紧张氛围
  - 可以使用怪物定义中的`battle_description_template`作为参考
- **示例**: 
  - `"突然，你听到前方传来低沉的咆哮声。一只巨大的魔物从庄稼中冲了出来！它有着锋利的爪子和凶狠的眼神，显然把你当作了猎物。"`
  - `""` - 不出现怪物时为空字符串
- **注意事项**:
  - **描述应该与Agent的实际响应相关**，反映Agent的遭遇情况
  - 描述应该与怪物类型和当前场景匹配
  - 应该营造适当的紧张感和威胁感
  - 如果Agent响应中描述了战斗或遭遇，怪物描述应该与之呼应

### 5. transition_target

- **类型**: `string | null`
- **必填**: 是
- **说明**: 目标场景或房间ID
- **格式要求**:
  - 使用场景ID（如 `"scene_002"`）或房间ID（如 `"room_002_001"`）
  - 目标ID必须存在于当前场景/房间的可连接目标列表中
  - 如果不转换场景/房间，必须为 `null`
  - **重要**：只能由核心事件触发场景转换，随机事件不能触发场景转换
- **示例**: 
  - `"scene_002"` - 转换到一级场景"田野"
  - `"room_002_001"` - 转换到二级场景（房间）"田野入口"
  - `null` - 不转换场景/房间
- **注意事项**:
  - **必须基于Agent的实际响应**来决定是否转换场景/房间
  - 必须遵守场景连接网络，不能跳转到未连接的场景
  - 必须检查连接的前置条件是否满足
  - 场景转换必须由事件驱动
  - 如果Agent响应中明确表示移动、到达、进入某个地点，应该考虑场景转换
  - 场景转换应该与Agent的实际行为一致

### 6. transition_type

- **类型**: `string`
- **必填**: 是（如果transition_target不为null）
- **说明**: 转换类型
- **可选值**: 
  - `"scene"` - 转换到一级场景（主场景）
  - `"room"` - 转换到二级场景（房间）
- **格式要求**:
  - 必须与transition_target的类型匹配
  - 如果transition_target是场景ID（以`scene_`开头），transition_type必须是`"scene"`
  - 如果transition_target是房间ID（以`room_`开头），transition_type必须是`"room"`
- **示例**: 
  - `"scene"` - 转换到场景
  - `"room"` - 转换到房间
- **注意事项**:
  - 如果transition_target为null，transition_type仍然需要提供（可以是任意值，但建议使用`"scene"`作为默认值）

### 7. elapsed_time

- **类型**: `number` (float)
- **必填**: 是
- **说明**: 本次操作消耗的游戏内时间（单位：分钟）
- **格式要求**:
  - 必须是数字（浮点数）
  - 范围通常在 1-30 分钟之间
  - 不能为null、0或负数
  - 必须根据操作复杂度合理估算
- **时间消耗参考**:
  - **简单对话/观察**：1-3分钟
    - 例如：与NPC简单对话、观察环境
  - **探索/调查**：3-10分钟
    - 例如：搜索物品、调查线索、探索新区域
  - **战斗**：5-15分钟
    - 例如：与怪物战斗、解决冲突
  - **场景转换**：2-5分钟
    - 例如：从一个场景移动到另一个场景
  - **复杂操作**：10-30分钟
    - 例如：完成复杂任务、解决谜题、进行长时间探索
- **示例**: 
  - `5.0` - 消耗5分钟游戏内时间
  - `12.5` - 消耗12.5分钟游戏内时间
  - `1.0` - 消耗1分钟游戏内时间（最小推荐值）
- **注意事项**:
  - **时间消耗应该与Agent的实际行为匹配**
  - 时间消耗应该与操作复杂度匹配
  - 如果触发事件，时间消耗应该考虑事件本身的复杂度
  - 如果进行战斗，时间消耗应该更长
  - 如果Agent响应中描述了长时间的操作（如探索、战斗），时间消耗应该更长
  - 时间消耗会影响事件触发条件（如"在场景中停留超过5分钟"）

### 8. reasoning

- **类型**: `string`
- **必填**: 是
- **说明**: 决策理由（隐藏，用于调试）
- **格式要求**:
  - 应该简要说明为什么做出这个决策
  - 可以包含对触发条件的评估
  - 可以包含对剧情推进的考虑
- **示例**: 
  - `"玩家表现出帮助意愿，且已满足事件触发条件（在场景中停留超过5分钟），应该触发接受任务事件并引导玩家前往田野"`
  - `"玩家深入田野，满足随机遭遇条件，触发战斗事件"`
  - `"玩家只是简单观察，不需要触发事件"`
- **注意事项**:
  - 虽然这个字段是隐藏的，但应该认真填写，有助于调试和理解LLM的决策逻辑
  - **应该说明如何基于Agent的实际响应做出决策**，包括：
    - Agent响应中的关键行为
    - Agent的状态变化如何影响决策
    - 为什么选择触发某个事件或转换场景

## 完整示例

### 示例1：触发核心事件并转换场景

```json
{
    "trigger_event": "event_001",
    "event_description": "年长的村民注意到你，走过来向你求助：\"冒险者，我们的田野被魔物侵扰，庄稼被毁，村民们都不敢去田里了。你能帮我们清剿这些魔物吗？我们会给予报酬的。\"",
    "appear_monster": null,
    "monster_description": "",
    "transition_target": "scene_002",
    "transition_type": "scene",
    "elapsed_time": 5.0,
    "reasoning": "玩家表现出帮助意愿，且已满足事件触发条件（在场景中停留超过5分钟），应该触发接受任务事件并引导玩家前往田野"
}
```

**说明**：
- 触发核心事件`event_001`（接受清剿任务）
- 不出现怪物
- 转换到场景`scene_002`（田野）
- 消耗5分钟游戏内时间

### 示例2：触发随机事件（遭遇怪物）

```json
{
    "trigger_event": "random_003",
    "event_description": "突然，你听到前方传来低沉的咆哮声。一只巨大的魔物从庄稼中冲了出来！",
    "appear_monster": "田野魔物",
    "monster_description": "它有着锋利的爪子和凶狠的眼神，显然把你当作了猎物。",
    "transition_target": null,
    "transition_type": "scene",
    "elapsed_time": 12.0,
    "reasoning": "玩家深入田野，满足随机遭遇条件（在场景中停留超过10分钟），触发战斗事件"
}
```

**说明**：
- 触发随机事件`random_003`（遭遇魔物）
- 出现怪物"田野魔物"
- 不转换场景（随机事件不能触发场景转换）
- 消耗12分钟游戏内时间（战斗需要更长时间）

### 示例3：不触发任何事件

```json
{
    "trigger_event": null,
    "event_description": "",
    "appear_monster": null,
    "monster_description": "",
    "transition_target": null,
    "transition_type": "scene",
    "elapsed_time": 2.0,
    "reasoning": "玩家只是简单观察环境，不需要触发事件，消耗少量时间"
}
```

**说明**：
- 不触发任何事件
- 不出现怪物
- 不转换场景
- 消耗2分钟游戏内时间（简单观察）

### 示例4：触发核心事件发现巢穴并转换房间

```json
{
    "trigger_event": "event_003",
    "event_description": "你仔细观察被破坏的谷仓，发现里面有一个隐藏的入口。从入口中传来更强烈的魔物气息，这里可能就是魔物的巢穴！",
    "appear_monster": null,
    "monster_description": "",
    "transition_target": "room_002_003",
    "transition_type": "room",
    "elapsed_time": 8.0,
    "reasoning": "玩家已击败魔物并满足发现巢穴的条件，触发发现巢穴事件并引导进入魔物巢穴"
}
```

**说明**：
- 触发核心事件`event_003`（发现魔物巢穴）
- 不出现怪物
- 转换到房间`room_002_003`（魔物巢穴）
- 消耗8分钟游戏内时间（探索和发现需要时间）

## 验证规则

### 1. 事件验证
- `trigger_event`必须存在于当前场景的潜在事件列表中
- 如果事件有前置条件（prerequisite），必须满足
- 核心事件可以触发场景转换，随机事件不能触发场景转换

### 2. 怪物验证
- `appear_monster`必须存在于当前场景/房间的潜在怪物列表中
- 怪物必须与当前场景/房间绑定
- 必须检查怪物的出现条件是否满足

### 3. 场景转换验证
- `transition_target`必须存在于当前场景/房间的可连接目标列表中
- 必须检查连接的前置条件是否满足
- `transition_type`必须与`transition_target`的类型匹配
- 场景转换只能由核心事件驱动

### 4. 时间验证
- `elapsed_time`必须在合理范围内（1-30分钟）
- 时间消耗应该与操作复杂度匹配
- 如果触发事件，时间消耗应该考虑事件本身的复杂度

## 常见错误

### 错误1：使用事件名称而不是事件ID
```json
// ❌ 错误
"trigger_event": "接受清剿任务"

// ✅ 正确
"trigger_event": "event_001"
```

### 错误2：随机事件触发场景转换
```json
// ❌ 错误
{
    "trigger_event": "random_003",
    "transition_target": "scene_002"  // 随机事件不能触发场景转换
}

// ✅ 正确
{
    "trigger_event": "random_003",
    "transition_target": null  // 随机事件不触发场景转换
}
```

### 错误3：时间消耗不合理
```json
// ❌ 错误
{
    "elapsed_time": 0,  // 不能为0
    "elapsed_time": 100  // 超出合理范围
}

// ✅ 正确
{
    "elapsed_time": 5.0  // 合理的时间消耗
}
```

### 错误4：transition_type与transition_target不匹配
```json
// ❌ 错误
{
    "transition_target": "room_002_001",
    "transition_type": "scene"  // 应该是"room"
}

// ✅ 正确
{
    "transition_target": "room_002_001",
    "transition_type": "room"
}
```

## 时间系统说明

### 游戏内时间 vs 现实时间
- 游戏内时间独立于现实时间
- 每次操作都会消耗一定的游戏内时间（由LLM返回的`elapsed_time`决定）
- 时间管理器会跟踪并更新游戏内时间

### 时间对事件触发的影响
- 事件触发条件可能包含时间条件（如"在场景中停留超过5分钟"）
- LLM需要根据当前游戏内时间和事件触发条件来判断是否应该触发事件
- 时间消耗会影响后续事件的触发条件判断

### 时间格式
- 游戏内时间以"第X天 HH:MM"的格式显示
- 例如："第1天 14:30"表示游戏内第1天的下午2点30分

## 注意事项

1. **基于Agent响应做决策**：**所有决策都应该基于Agent的实际响应**，而不仅仅是玩家指令。Agent的响应、状态变化和属性变化是导演评估的重要依据。
2. **必须使用事件ID**：`trigger_event`必须使用事件ID（如`"event_001"`），不能使用事件名称
3. **时间消耗必须提供**：`elapsed_time`必须提供，且应该在合理范围内（1-30分钟），应该与Agent的实际行为匹配
4. **场景转换限制**：只有核心事件可以触发场景转换，随机事件不能触发场景转换
5. **必须遵守连接网络**：`transition_target`必须从可连接目标列表中选择
6. **类型匹配**：`transition_type`必须与`transition_target`的类型匹配
7. **前置条件检查**：必须检查事件和场景转换的前置条件是否满足
8. **描述完整性**：如果触发事件或出现怪物，必须提供完整的描述文本，且应该与Agent的实际响应相关
9. **决策一致性**：所有决策应该与Agent的实际行为保持一致，不能出现矛盾

## 调试建议

1. **检查reasoning字段**：查看LLM的决策理由，了解为什么做出某个决策
2. **验证事件ID**：确保使用的事件ID存在于当前场景的潜在事件列表中
3. **检查时间消耗**：确保时间消耗合理，不会导致事件触发条件判断错误
4. **验证场景转换**：确保场景转换符合连接网络和前置条件

## 系统中所有LLM调用场景

本文档主要说明**导演评估**的LLM调用，但系统中还有其他LLM调用场景。以下是完整的LLM调用场景列表（按执行顺序排列）：

### 1. Agent响应生成（步骤4.1）

**位置**：`services/agent.py` → `Agent.process_instruction()`

**调用时机**：在处理玩家指令时，为每个角色并行调用LLM生成响应

**输入信息**：详见`传递给LLM的信息说明.md`第1节

**输出格式（JSON）**：
```json
{
    "response": "响应文本（2-3句，体现角色风格，包含行动和结果）",
    "state_changes": {
        "surface": {
            "perceived_state": "玩家可见的状态变化描述"
        },
        "hidden": {
            "observer_state": "观察者可见的状态",
            "inner_monologue": "内心独白"
        }
    },
    "attribute_changes": {
        "属性名": "属性值"
    },
    "execution_result": {
        "success": true/false,
        "failure_reason": "失败原因（如果失败）",
        "actual_outcome": "实际执行结果"
    }
}
```

**字段说明**：
- `response`：角色的响应文本，包含对话和行为描述，体现角色性格和说话风格
- `state_changes`：状态变化，分为`surface`（玩家可见）和`hidden`（隐藏信息）
- `attribute_changes`：属性变化，如HP、MP、经验值等
- `execution_result`：执行结果，包含成功/失败状态和实际结果

**统一停止点说明**：

统一停止点的功能由**导演评估**承担。导演评估会在Agent响应生成之后，基于Agent的实际响应决定事件触发和统一停止点，确保所有Agent在同一时刻停止。

**用途**：生成每个角色对玩家指令的实际响应

**特点**：
- 并行处理：所有Agent同时调用LLM
- 个性化：每个Agent根据角色设定生成独特的响应

---

### 2. 环境变化分析（步骤6）

**位置**：`services/environment_analyzer.py` → `EnvironmentAnalyzer.analyze_environment_changes()`

**调用时机**：在Agent响应生成之后，分析所有响应对环境的影响

**输入信息**：详见`传递给LLM的信息说明.md`第3节

**输出格式（JSON）**：
```json
{
    "scene_changes": {
        "surface": {
            "time": "时间信息（如'第1天 14:30'）",
            "location": {
                "region": "区域名称",
                "specific_location": "具体位置",
                "coordinates": "坐标信息（可选）",
                "environment": "环境描述"
            },
            "current_narrative": "当前叙事状态",
            "goal": "当前目标",
            "resources": "资源信息"
        },
        "hidden": {
            "final_goal": "最终目标",
            "potential_enemies": "潜在敌人",
            "risk_hints": "风险提示"
        }
    },
    "major_events": [
        "事件描述1",
        "事件描述2"
    ],
    "decision_points": {
        "has_decision": true/false,
        "description": "决策描述",
        "options": ["选项1", "选项2"]
    },
    "status_summary": {
        "current_location": "当前位置",
        "current_time": "当前时间",
        "goal_progress": "目标进度",
        "next_suggestions": ["建议1", "建议2", "建议3"]
    }
}
```

**字段说明**：
- `scene_changes`：场景变化，分为`surface`（玩家可见）和`hidden`（隐藏信息）
- `major_events`：重大事件列表，每个事件是一个描述文本
- `decision_points`：决策点信息，包含是否需要决策、决策描述和选项
- `status_summary`：状态总结，包含当前位置、时间、目标进度和下一步建议

**用途**：
- 分析Agent响应对环境的影响
- 提取场景变化（位置、时间、事件等）
- 识别主要事件
- 生成决策点

**特点**：
- 综合分析：分析所有Agent的响应
- 环境更新：更新场景描述和状态
- **位置更新优先级最高**：位置必须反映角色当前实际所在的地点，必须与事件发生地点一致

---

### 3. 导演评估（步骤6.1，本文档重点）

**重要**：导演评估负责决定事件触发和统一停止点，确保所有Agent在同一时刻停止。

**位置**：`services/director_evaluator.py` → `DirectorEvaluator.evaluate_as_director()`

**调用时机**：在Agent响应生成之后，基于Agent的实际响应进行导演评估

**输入信息**：详见`传递给LLM的信息说明.md`

**输出格式**：本文档详细说明的JSON格式

**用途**：
- 决定是否触发事件（核心事件/随机事件）
- 决定是否让怪物出现
- 决定是否转换场景/房间
- 估算时间消耗

**特点**：
- **基于Agent实际响应**：所有决策都应该基于Agent的实际响应
- 事件驱动：场景转换必须由事件驱动
- 遵守连接网络：只能转换到已定义的连接目标

---

### 4. 响应格式化（步骤8）

**位置**：`services/response_formatter.py` → `ResponseFormatter.format_responses_for_player()`

**调用时机**：在状态更新之后，将原始响应转换为玩家视角的文本

**输入信息**：详见`传递给LLM的信息说明.md`第4节

**输出格式（JSON）**：
```json
{
    "formatted_responses": [
        {
            "character_name": "角色名",
            "formatted_text": "格式化文本（保持角色语气）"
        }
    ],
    "summary": "摘要（第三人称视角，小说风格，以叙事为主，不要重复人物行动）"
}
```

**字段说明**：
- `formatted_responses`：格式化后的响应列表，每个响应包含角色名和格式化文本
- `summary`：第三人称、小说风格的摘要，以叙事为主，不重复人物行动

**摘要要求**：
- **第三人称视角**：禁止使用"我"、"我们"、"咱们"等第一人称
- **以叙事为主**：不要逐条列举角色行动，用流畅叙事描述整体场景和事件发展
- **小说风格**：语言生动优美，有画面感，可描写环境氛围，包含动作细节和心理暗示
- **保持角色语气**：格式化文本必须严格保持每个角色的说话风格和语气

**用途**：
- 将Agent的原始响应转换为适合玩家阅读的文本
- 生成第三人称、小说风格的摘要
- 合并表/里信息

**特点**：
- 玩家视角：转换为玩家角色的视角
- 小说风格：生成第三人称、小说风格的描述
- 保持角色语气：严格保持每个角色的说话风格

---

### 6. 问题回答（独立功能）

**位置**：`services/question_service.py` → `QuestionService.answer_question()`

**调用时机**：当玩家提出问题时（独立于主流程）

**输入信息**：
- 玩家问题
- 场景内容
- 角色信息
- 对话历史

**输出格式**：
- 回答文本（文本格式）

**用途**：
- 回答玩家关于游戏世界的问题
- 提供游戏信息查询功能

**特点**：
- 独立功能：不参与主流程
- 信息查询：用于回答玩家问题

---

## LLM调用流程总结

```
玩家指令
  ↓
1. Agent响应生成（LLM调用1，并行，每个角色，步骤4.1）
  ↓
2. 环境变化分析（LLM调用2，步骤6）
  ↓
3. 导演评估（LLM调用3，基于Agent响应，步骤6.1）← 本文档重点
   - 负责决定事件触发和统一停止点，确保所有Agent在同一时刻停止
  ↓
4. 响应格式化（LLM调用4，步骤8）
  ↓
返回给玩家
```

**注意**：
- 本文档主要说明**导演评估**（LLM调用4）的返回格式
- 其他LLM调用的返回格式各不相同，详见各自的实现文件
- 导演评估是最重要的LLM调用，因为它决定了事件触发、怪物出现和场景转换

