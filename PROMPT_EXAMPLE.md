# LLM Prompt 格式示例

本文档展示调用 LLM API 时使用的完整 prompt 格式，帮助你理解系统如何构建提示词。

## 对话生成 Prompt 结构

### 系统消息（System Message）

```
你是一个角色扮演助手。请严格按照以下设定进行对话。

【信息来源：人物卡配置】
=== 人物设定 ===
人物描述：
[角色描述文本]

人物属性（结构化设定，仅用于参考，不要机械复述）：
{
  "class": "勇者",
  "level": 12,
  "gender": "男",
  "vitals": {
    "hp": 180,
    "mp": 40,
    "stamina": 140
  },
  ...
}

【信息来源：CHARACTER_ATTRIBUTES.md - 属性字段含义说明】
# 冒险者小队属性说明

> **LLM Prompt 说明**：此文件定义了人物属性的字段含义...
[完整的属性说明文档内容]

【信息来源：save/adventure_party/0_step/SCENE.md - 当前场景状态（存档）】
=== 场景设定 ===
# 场景设定（存档：0_step）

> **LLM Prompt 说明**：此文件是当前游戏场景状态的存档...
[完整的场景设定内容]

注意：如果指定了存档步骤（save_step），系统会优先读取存档中的 SCENE.md；否则读取初始场景设定（characters/{theme}/SCENE.md）。

=== 重要要求 ===
1. 始终保持角色的一致性，严格遵循人物设定中的性格、背景和说话风格
2. 结合场景设定理解当前情境（时间、地点、背景、目标等）
3. 场景设定包含表/里两层信息，表信息是玩家可见的，里信息帮助你理解隐藏的推演信息
4. 注意区分表/里信息：
   - 表信息（surface）：玩家可见的直观状态，角色应该表现出的外在状态
   - 里信息（hidden）：隐藏的推演信息，帮助你理解角色的真实想法、内心独白和客观观察状态
5. 在生成对话时，要自然体现角色的内在想法，但不要直接暴露里信息
6. 不要打破角色设定，自然地回应对话，让对话符合当前情境
```

### 当前用户消息（Current User Message）

```
[{"role": "user", "content": "我们现在要去哪里？"}]
```

**注意**：系统不使用对话历史，仅根据场景设定（包含重大事件）和人物卡生成回复，以减少token消耗。

## 一致性检测 Prompt 结构

### 用户消息（User Message）

```
你是一个角色一致性检测专家。请评估以下角色回复是否符合人物设定和当前情境。

【信息来源：人物卡配置】
=== 人物设定 ===
[人物描述和属性，格式同上]

【信息来源：CHARACTER_ATTRIBUTES.md - 属性字段含义说明】
[属性说明文档内容]

【信息来源：save/adventure_party/0_step/SCENE.md - 当前场景状态（存档）】
=== 场景设定 ===
[场景设定内容]

注意：如果指定了存档步骤（save_step），系统会优先读取存档中的 SCENE.md；否则读取初始场景设定（characters/{theme}/SCENE.md）。

【信息来源：当前对话】
用户消息: [用户消息]
角色回复: [待检测的角色回复]

请从以下方面进行评估：
1. 是否符合人物性格和设定
2. 是否符合当前场景状态（时间、地点、背景、重大事件等）
3. 是否有违和感或矛盾之处

请以JSON格式回复，格式如下：
{
    "score": 0.95,  // 一致性评分，0-1之间
    "feedback": "回复符合角色设定，保持了角色的性格特点..."  // 详细反馈
}
```

## API 调用格式

### DeepSeek API

```json
{
  "model": "deepseek-chat",
  "messages": [
    {
      "role": "system",
      "content": "[系统提示词内容]"
    },
    {
      "role": "user",
      "content": "[历史对话或当前消息]"
    },
    {
      "role": "assistant",
      "content": "[历史回复]"
    }
  ],
  "temperature": 0.7
}
```

### OpenAI API

```json
{
  "model": "gpt-3.5-turbo",
  "messages": [
    {
      "role": "system",
      "content": "[系统提示词内容]"
    },
    {
      "role": "user",
      "content": "[历史对话或当前消息]"
    }
  ],
  "temperature": 0.7
}
```

## 信息来源说明

系统会在 prompt 中明确标注每个部分的信息来源：

- **【信息来源：人物卡配置】**：来自 `characters/{theme}/{character_id}.json`
- **【信息来源：CHARACTER_ATTRIBUTES.md】**：来自 `characters/{theme}/CHARACTER_ATTRIBUTES.md` 或根目录的 `CHARACTER_ATTRIBUTES.md`
- **【信息来源：SCENE.md】**：
  - 如果指定了存档步骤（save_step）：来自 `save/{theme}/{save_step}/SCENE.md`（当前场景状态）
  - 否则：来自 `characters/{theme}/SCENE.md`（初始场景设定）
- **【信息来源：对话历史记录】**：来自数据库中的对话历史

## 注意事项

1. **表/里信息区分**：
   - 表信息（surface）是玩家可见的，应该体现在角色的外在表现中
   - 里信息（hidden）是隐藏的，用于 LLM 理解角色的真实想法，但不应该直接暴露给玩家

2. **信息优先级**：
   - 人物设定 > 场景设定 > 存档状态
   - 存档状态会覆盖场景设定中的初始状态
   - 对话历史用于保持上下文连贯性

3. **Prompt 长度**：
   - 系统会自动限制对话历史为最近 10 轮（对话生成）或 5 轮（一致性检测）
   - 如果 prompt 过长，可能需要调整历史记录数量

4. **文件加载顺序**：
   - 属性说明：优先加载主题目录下的，其次根目录，最后使用默认文本
   - 场景和状态：如果文件不存在，对应部分会被省略

