# 指令执行说明

## 概述

指令执行系统确保玩家的指令得到执行，同时考虑环境因素可能导致执行失败的情况。

## 核心原则

### 1. 指令必须执行

玩家的指令是**必须执行的行动**，不是建议或讨论：

- ✅ **正确**："我开始向上攀爬，尝试抓住墙壁上的凸起..."
- ❌ **错误**："我考虑是否要爬上去，这可能需要一些时间..."

### 2. 执行可能失败

由于环境因素，指令执行可能失败：

- **物理障碍**：墙壁太滑、距离太远、障碍物阻挡
- **能力限制**：体力不足、技能不够、装备缺失
- **环境因素**：天气、地形、时间限制

### 3. 执行过程要具体

必须描述具体的行动过程，而不是简单地说"执行了"：

- ✅ **正确**："我向遗迹入口方向移动，但前方有深沟阻挡，无法直接通过。我尝试寻找其他路径..."
- ❌ **错误**："好的，我移动到遗迹入口了。"

## 执行结果格式

Agent返回的JSON包含执行结果：

```json
{
    "response": "具体的行动描述...",
    "state_changes": {...},
    "attribute_changes": {...},
    "execution_result": {
        "success": true/false,
        "failure_reason": "失败原因（如果失败）",
        "actual_outcome": "实际结果描述"
    }
}
```

## 执行示例

### 示例1：成功执行

**指令**：`爬上去`

**响应**：
```json
{
    "response": "我开始向上攀爬，双手抓住墙壁上的凸起，脚踩在石缝中。经过一番努力，我成功爬到了顶部。",
    "execution_result": {
        "success": true,
        "actual_outcome": "成功爬到顶部"
    },
    "attribute_changes": {
        "vitals": {
            "stamina": 80  // 消耗了体力
        }
    }
}
```

### 示例2：执行失败

**指令**：`爬上去`

**响应**：
```json
{
    "response": "我开始向上攀爬，但墙壁太滑，尝试了几次都滑了下来。我检查了墙壁表面，发现没有足够的抓握点。",
    "execution_result": {
        "success": false,
        "failure_reason": "墙壁太滑，没有足够的抓握点",
        "actual_outcome": "尝试攀爬但失败，仍在原地"
    },
    "attribute_changes": {
        "vitals": {
            "stamina": 90  // 消耗了体力但未成功
        }
    }
}
```

### 示例3：部分成功

**指令**：`移动到遗迹入口`

**响应**：
```json
{
    "response": "我向遗迹入口方向移动，但前方有深沟阻挡。我尝试寻找其他路径，发现需要绕行。我沿着深沟边缘寻找安全通道...",
    "execution_result": {
        "success": false,
        "failure_reason": "深沟阻挡，无法直接到达",
        "actual_outcome": "移动到深沟边缘，需要寻找其他路径"
    }
}
```

## Prompt设计

### 关键要求

1. **指令必须执行**：明确说明指令是必须执行的行动
2. **执行可能失败**：说明环境因素可能导致失败
3. **描述要具体**：必须描述具体的行动过程
4. **失败要说明**：如果失败，要说明失败的原因和结果

### Prompt结构

```
玩家指令：{instruction}

【重要】你必须执行玩家指令，但要注意：
1. 指令必须执行：玩家指令是必须执行的行动，不是建议或讨论
2. 执行可能失败：由于环境因素，指令执行可能失败
3. 执行过程要具体：描述你如何执行指令

请生成：
1. 响应：具体的行动过程和结果
2. 状态变化：执行后的状态变化
3. 执行结果：成功/失败，失败原因，实际结果
```

## 与环境的交互

### 环境因素

执行指令时需要考虑：

- **地形**：是否有障碍物、是否可通行
- **距离**：是否在可到达范围内
- **时间**：是否有时间限制
- **资源**：是否需要消耗体力、魔法等
- **能力**：角色是否有能力执行

### 失败处理

如果执行失败：

1. **说明失败原因**：为什么失败
2. **描述实际结果**：实际发生了什么
3. **更新状态**：可能消耗了资源但未成功
4. **提供后续建议**：可以尝试什么

## 注意事项

1. **不要假设成功**：不要假设指令一定能成功执行
2. **考虑环境限制**：根据场景信息判断是否可能成功
3. **消耗资源**：即使失败，也可能消耗体力等资源
4. **描述要真实**：失败也要有具体的行动描述，不是"无法执行"

## 相关文件

- `services/agent.py` - Agent类，包含指令执行逻辑
- `PROMPT_EXAMPLE.md` - Prompt示例

