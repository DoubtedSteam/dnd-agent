# 提问功能说明

## 概述

提问功能允许玩家询问问题，系统会根据玩家角色、人物卡信息和环境信息来回答，**不会推进游戏步骤**。

## 特点

- ✅ **一致性检查**：严格检查回答与历史信息的一致性
- ✅ **具体化信息提取**：自动提取回答中具体化的信息
- ✅ **场景更新**：如果一致性检查通过，创建新步骤并更新场景
- ✅ **基于上下文**：依据玩家角色、人物卡、环境信息回答
- ✅ **表/里区分**：只回答玩家应该知道的信息（表信息）

## API 接口

### 提问接口

```http
POST /api/themes/{theme}/question
Content-Type: application/json
```

**请求体**：
```json
{
  "question": "队伍现在有多少人？",
  "save_step": "0_step",  // 可选：指定存档步骤
  "character_ids": ["hero", "mage"],  // 可选：指定参考的角色
  "platform": "deepseek",  // 可选：指定API平台
  "player_role": "冒险者小队队长"  // 可选：玩家角色
}
```

**响应**：
```json
{
  "answer": "作为队长，你知道队伍目前有4名成员：勇者艾伦、魔法师莉娜、牧师艾米和盗贼凯。",
  "question": "队伍现在有多少人？",
  "consistency_check": {
    "score": 0.95,
    "feedback": "回答与历史信息一致，没有发现矛盾",
    "concretized_info": {
      "surface": {
        "current_narrative": "队伍由4名成员组成"
      },
      "hidden": {}
    },
    "scene_updates": {
      "surface": {},
      "hidden": {}
    },
    "major_events": []
  },
  "new_step": "1_step"
}
```

**注意**：
- 如果提供了`save_step`，会进行一致性检查
- 如果一致性检查通过（评分>=0.7），会创建新步骤并更新场景
- 如果一致性检查未通过，不会创建新步骤，但会返回警告

## 使用场景

### 1. 查询角色信息

```json
{
  "question": "勇者现在的状态如何？"
}
```

### 2. 查询场景信息

```json
{
  "question": "我们现在在哪里？"
}
```

### 3. 查询队伍状态

```json
{
  "question": "队伍的整体状态如何？"
}
```

### 4. 查询游戏规则

```json
{
  "question": "如何恢复生命值？"
}
```

## 与执行指令的区别

| 特性 | 执行指令 (`/execute`) | 提问 (`/question`) |
|------|---------------------|-------------------|
| 推进游戏 | ✅ 是 | ⚠️ 可能（如果具体化信息） |
| 创建新步骤 | ✅ 是 | ✅ 是（如果一致性检查通过） |
| 更新状态 | ✅ 是 | ✅ 是（如果一致性检查通过） |
| 一致性检查 | ❌ 否 | ✅ 是（严格检查） |
| 多智能体响应 | ✅ 是 | ❌ 否 |
| 格式化响应 | ✅ 是 | ❌ 否 |
| 调用次数 | 多次（每个智能体+环境分析+格式化） | 2次（回答+一致性检查） |
| 用途 | 执行行动，推进游戏 | 查询信息，可能具体化信息 |

## 工作流程

```
1. 玩家提出问题
   ↓
2. 加载场景（包含玩家角色信息）
   ↓
3. 加载角色信息（人物卡）
   ↓
4. 构建提示词（玩家角色+场景+人物卡）
   ↓
5. 调用LLM回答问题
   ↓
6. 【如果提供了save_step】加载历史场景信息
   ↓
7. 【一致性检查】检查回答与历史信息的一致性
   ↓
8. 【提取具体化信息】从回答中提取具体化的信息
   ↓
9. 【如果一致性检查通过（评分>=0.7）】
   - 创建新存档步骤
   - 更新场景文件（添加具体化信息）
   ↓
10. 返回答案、一致性检查结果、新步骤信息
```

## 回答原则

1. **玩家视角**：从玩家角色的视角回答问题
2. **表信息优先**：只回答玩家应该知道的信息（表信息）
3. **不暴露隐藏信息**：里信息（hidden）不直接暴露，但可以帮助理解背景
4. **准确有用**：回答要准确、有帮助，符合游戏设定
5. **综合信息**：如果问题涉及多个角色，可以综合多个角色的信息

## 示例

### 示例1：查询角色状态

**请求**：
```json
{
  "question": "勇者现在的生命值是多少？",
  "save_step": "0_step"
}
```

**回答**：
```
作为队长，你知道勇者艾伦目前的生命值是180/180，状态良好，准备就绪。
```

### 示例2：查询场景信息

**请求**：
```json
{
  "question": "我们当前的任务是什么？"
}
```

**回答**：
```
根据公会委托，你们当前的任务是调查遗迹入口周边的魔物来源，并确保商路安全。任务要求避免惊动镇民，优先保护平民与商队。
```

### 示例3：查询队伍信息

**请求**：
```json
{
  "question": "队伍成员都有哪些技能？"
}
```

**回答**：
```
作为队长，你了解队伍成员的技能：
- 勇者艾伦：擅长近战，有防御技能
- 魔法师莉娜：掌握多种攻击和辅助法术
- 牧师艾米：擅长治疗和支援
- 盗贼凯：擅长侦察和潜行
```

## 注意事项

1. **一致性检查**：如果提供了`save_step`，会严格检查回答与历史信息的一致性
2. **场景更新**：如果一致性检查通过（评分>=0.7），会创建新步骤并更新场景
3. **具体化信息**：自动提取回答中具体化的信息，更新到场景中
4. **信息范围**：只能回答玩家角色应该知道的信息
5. **表/里区分**：不会直接暴露隐藏信息，但会更新到场景的隐藏部分
6. **不提供save_step**：如果不提供`save_step`，只回答问题，不进行一致性检查和场景更新

## 相关文件

- `services/question_service.py` - 提问服务实现
- `app.py` - API端点定义

