# 命令行界面（CLI）使用指南

## 概述

CLI版本允许你通过终端直接使用智能体平台，无需图形界面。适合在服务器环境或喜欢命令行操作的用户。

### 特色功能

- ✅ **进度条显示**：执行指令和提问时显示实时进度条
- ✅ **彩色输出**：使用Rich库提供美观的彩色输出
- ✅ **实时反馈**：显示操作状态和进度
- ✅ **交互式界面**：友好的命令行交互体验

## 快速开始

### 方法1：手动启动

#### 1. 启动服务器

首先，确保服务器正在运行：

```bash
# 在项目根目录
python app.py
```

你应该看到：
```
 * Running on http://127.0.0.1:5000
```

#### 2. 启动CLI

在另一个终端窗口中：

```bash
python cli.py
```

### 方法2：使用启动脚本

#### Windows

```bash
start_cli.bat
```

#### Linux/Mac

```bash
chmod +x start_cli.sh
./start_cli.sh
```

### 启动后你应该看到：
```
================================================================================
🤖 智能体平台 CLI
================================================================================

正在连接服务器...
✅ 服务器连接成功

=== 智能体平台 CLI 使用指南 ===
...
```

### 安装依赖

如果首次使用，需要安装新的依赖：

```bash
pip install -r requirements.txt
```

新增依赖：
- `tqdm` - 进度条库
- `rich` - 终端美化库

## 基本命令

### 执行指令

执行指令会推进游戏，创建新存档步骤，更新状态。

**重要**：指令必须执行，但可能因为环境因素而失败。

```
> execute 我们出发去遗迹
```

或简写：
```
> e 我们出发去遗迹
```

**指令执行说明**：
- 指令是**必须执行的行动**，不是建议或讨论
- 例如："爬上去" 意味着执行"爬"这个动作，而不是讨论是否要爬
- 执行可能因为环境因素而失败（如墙壁太滑、障碍物阻挡等）
- 如果失败，会显示失败原因和实际结果

### 提问

提问会检查一致性，如果回答具体化了信息，会创建新步骤并更新场景。

```
> question 队伍现在有多少人？
```

或简写：
```
> ask 队伍现在有多少人？
```

**注意**：
- 如果当前有存档步骤，会进行一致性检查
- 如果一致性检查通过（评分>=0.7），会创建新步骤并更新场景
- 如果一致性检查未通过，不会创建新步骤，但会显示警告

### 列出角色

```
> list
```

或简写：
```
> ls
```

### 列出所有主题（剧本）

```
> themes
```

显示所有可用的主题（剧本），当前主题会标记为绿色。

**示例**：
```
> themes

================================================================================
📋 可用主题（剧本）列表
================================================================================

  ✓ adventure_party (当前)

  another_theme

使用 'theme <主题名>' 切换主题
```

### 查看角色信息

```
> char hero
```

或：
```
> character hero
```

### 切换主题（剧本）

```
> theme adventure_party
```

或简写：
```
> t adventure_party
```

**注意**：
- 切换主题时会自动重置存档步骤为 `0_step`
- 如果主题不存在，会显示错误和可用主题列表
- 不提供参数时，会显示当前主题和所有可用主题

### 查看Token消耗统计

```
> tokens
```

显示当前会话的token消耗统计，包括：
- 总调用次数和总token数
- 按平台统计（deepseek/openai）
- 按操作类型统计（对话、智能体响应、一致性检查等）
- 会话时长

**示例**：
```
> tokens

================================================================================
📊 Token消耗统计
================================================================================

总调用次数: 15
总Token数: 12,345
  输入Token: 8,234
  输出Token: 4,111

按平台统计:
  deepseek: 15 次调用, 12,345 tokens

按操作类型统计:
  智能体响应: 4 次调用, 5,234 tokens
  环境分析: 3 次调用, 3,456 tokens
  响应格式化: 3 次调用, 2,345 tokens
  一致性检查: 2 次调用, 1,234 tokens
  问题回答: 2 次调用, 76 tokens
  对话: 1 次调用, 0 tokens

会话时长: 5分23秒
```

**提示**：
- `status` 命令也会显示简要的token统计
- Token统计会在每次API调用后自动更新

### 切换存档步骤

```
> step 1_step
```

或简写：
```
> st 1_step
```

### 设置玩家角色

```
> role 冒险者小队队长
```

或简写：
```
> r 冒险者小队队长
```

### 查看当前状态

```
> status
```

或简写：
```
> s
```

### 显示帮助

```
> help
```

或简写：
```
> h
```

### 退出程序

```
> exit
```

或：
```
> quit
```

或简写：
```
> q
```

## 使用示例

### 示例1：基本游戏流程

```
[adventure_party/0_step] > execute 我们出发去遗迹调查

⏳ 执行指令: 我们出发去遗迹调查

执行指令中... (调用多个智能体，可能需要一些时间) ████████████ 100% 0:00:15

================================================================================
📋 执行结果
================================================================================

【角色响应】

勇者:
  作为队长，你看到勇者艾伦举起盾牌，示意队伍前进。他坚定地说道："好的，我们出发！保持警戒队形——凯在前方侦察，莉娜和艾米在中间，我殿后。"

魔法师:
  魔法师莉娜检查了一下法杖，点头说道："我已经准备好了必要的法术，随时可以支援。"

...

✅ 新存档步骤: 1_step

[adventure_party/1_step] > 
```

### 示例2：查询信息

```
[adventure_party/1_step] > question 队伍现在的状态如何？

⏳ 正在回答问题...

正在思考并回答问题... ████████████ 100% 0:00:05

================================================================================
❓ 问题回答
================================================================================

问题: 队伍现在的状态如何？

回答:
作为队长，你知道队伍目前状态良好。勇者艾伦在前方开路，保持警戒；魔法师莉娜已经准备好法术支援；牧师艾米随时准备治疗；盗贼凯正在前方侦察。队伍士气稳定，准备充分。

一致性检查:
  ✅ 评分: 0.95
  回答与历史信息一致，没有发现矛盾

✅ 新存档步骤: 2_step
```

### 示例3：查看角色信息

```
[adventure_party/1_step] > char hero

================================================================================
📋 角色信息: 艾伦·勇者
================================================================================

ID: hero
名称: 艾伦·勇者
主题: adventure_party

描述:
一个经验丰富的勇者，擅长近战和防御...

属性:
  生命值: 180
  魔法值: 40
  体力值: 140
```

### 示例4：切换存档步骤

```
[adventure_party/1_step] > step 0_step
✅ 已切换到存档步骤: 0_step

[adventure_party/0_step] > status

当前状态：
  主题: adventure_party
  存档步骤: 0_step
  玩家角色: （未设置，将从场景中提取）
  服务器: ✅ 运行中
```

## 命令参考

| 命令 | 简写 | 说明 | 示例 |
|------|------|------|------|
| `execute <指令>` | `e <指令>` | 执行指令，推进游戏 | `e 我们出发` |
| `question <问题>` | `ask <问题>` | 提问，不推进游戏 | `ask 队伍有多少人？` |
| `list` | `ls` | 列出所有角色 | `list` |
| `themes` | - | 列出所有可用主题（剧本） | `themes` |
| `char <角色ID>` | - | 查看角色信息 | `char hero` |
| `theme <主题>` | `t <主题>` | 切换主题（剧本） | `t adventure_party` |
| `step <步骤>` | `st <步骤>` | 切换存档步骤 | `st 1_step` |
| `role <角色>` | `r <角色>` | 设置玩家角色 | `r 队长` |
| `status` | `s` | 显示当前状态 | `status` |
| `tokens` | - | 显示token消耗统计 | `tokens` |
| `help` | `h` | 显示帮助信息 | `help` |
| `exit/quit` | `q` | 退出程序 | `exit` |

## 提示和技巧

### 1. 命令自动补全

虽然CLI本身不支持自动补全，但你可以：
- 使用简写命令（如 `e` 代替 `execute`）
- 使用Tab键（如果终端支持）

### 2. 多行输入

目前不支持多行输入，如果指令很长，可以：
- 使用引号包裹：`e "这是一个很长的指令，包含多个部分"`
- 或者直接输入，系统会处理

### 3. 历史记录

大多数终端支持上下箭头键查看历史命令。

### 4. 服务器地址

默认连接到 `http://127.0.0.1:5000`。

如果需要连接到其他服务器，可以修改 `cli.py` 中的 `base_url`：

```python
cli = AgentCLI(base_url="http://your-server:5000")
```

### 5. 错误处理

如果遇到错误：
- 检查服务器是否运行：`status`
- 检查网络连接
- 查看错误信息，通常会有详细说明

## 工作流程示例

### 完整的游戏会话

```
# 1. 启动CLI
python cli.py

# 2. 查看当前状态
> status

# 3. 查看角色列表
> list

# 4. 执行第一个指令
> execute 我们出发去遗迹

# 5. 查看执行结果（自动显示）
# 系统会自动创建新步骤 1_step

# 6. 提问了解情况
> question 我们现在在哪里？

# 7. 继续执行指令
> execute 调查遗迹入口

# 8. 查看角色状态
> char hero

# 9. 切换回之前的步骤
> step 0_step

# 10. 退出
> exit
```

## 常见问题

### Q: 无法连接到服务器？

**A**: 确保：
1. 服务器正在运行：`python app.py`
2. 服务器地址正确（默认 `http://127.0.0.1:5000`）
3. 防火墙没有阻止连接

### Q: 命令不工作？

**A**: 
- 检查命令拼写
- 使用 `help` 查看可用命令
- 确保提供了必要的参数

### Q: 如何查看之前的存档步骤？

**A**: 
- 使用 `step <步骤名>` 切换
- 步骤命名格式：`0_step`, `1_step`, `2_step` 等

### Q: 可以同时运行多个CLI吗？

**A**: 可以，每个CLI都是独立的客户端，连接到同一个服务器。

## 与API的区别

CLI版本是对API的封装，提供：
- ✅ 交互式命令行界面
- ✅ 自动格式化输出
- ✅ 状态管理（当前主题、步骤等）
- ✅ 简化的命令语法

底层仍然使用相同的API接口。

## 相关文件

- `cli.py` - CLI主程序
- `app.py` - 服务器程序
- `CLI_README.md` - 本文件

## 下一步

- 查看 `README.md` 了解完整功能
- 查看 `MULTI_AGENT_SYSTEM.md` 了解多智能体系统
- 查看 `QUESTION_SERVICE.md` 了解提问功能

---

**祝你游戏愉快！** 🎮

